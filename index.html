<!doctype html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#0EA5E9" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#0B0C0F" media="(prefers-color-scheme: dark)">
<!-- üî• UPDATED: 2025-10-30 13:05 - Previous Workout fixes deployed -->
  <!-- Firebase SDK v8 CDN (—Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBWCJ9LnW8etrHHutf0-VSzmqsdmrOiEt4",
      authDomain: "training-50f1c.firebaseapp.com",
      projectId: "training-50f1c",
      storageBucket: "training-50f1c.firebasestorage.app",
      messagingSenderId: "776443693745",
      appId: "1:776443693745:web:e3244e8d7ad0ef9ac97090",
      measurementId: "G-P40RSFC6PZ"
    };

    // Initialize Firebase
    try {
      firebase.initializeApp(firebaseConfig);
      firebase.analytics();
      console.log("‚úÖ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
    } catch (error) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", error);
    }

    // Make db available globally
    window.db = firebase.firestore();
    console.log("üîó Firestore –ø–æ–¥–∫–ª—é—á–µ–Ω:", !!window.db);
  </script>
<style>
  :root {
    /* –¶–≤–µ—Ç–∞ ‚Äî —Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
    --bg: #FFFFFF;
    --fg: #0E1113;
    --muted: #58606A;
    --border: #E6E8EC;
    --card: #F8F9FB;

    --accent: #0EA5E9;
    --accent-ink: #06151C;

    --ok: #16A34A;
    --warn: #F59E0B;
    --err: #EF4444;

    --radius: 12px;
    --shadow-1: 0 1px 2px rgba(0,0,0,.06);
    --shadow-2: 0 8px 24px rgba(0,0,0,.12);

    /* Safe area –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    --safe-b: env(safe-area-inset-bottom);
    --safe-t: env(safe-area-inset-top);
    --gap: 12px;

    /* –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ */
    --font-sans: ui-sans-serif, system-ui, -apple-system, "Inter", "Geist", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
    --lh: 1.45;

    /* –®–∫–∞–ª—ã */
    --space-1: 4px;  --space-2: 8px;  --space-3: 12px; --space-4: 16px; --space-5: 20px;
    --space-6: 24px; --space-7: 32px; --space-8: 40px; --space-9: 48px;

    --fs-xs: 12px;
    --fs-sm: 13px;
    --fs-md: 14px;
    --fs-lg: 15px;
    --fs-h3: 16px;
    --fs-h2: 18px;
    --fs-h1: 20px;
  }

  :root[data-theme="dark"] {
    --bg: #0B0C0F;
    --fg: #EAECEF;
    --muted: #A3A9B3;
    --border: #1F242B;
    --card: #13161B;

    --accent: #7DD3FC;
    --accent-ink: #0B0E12;

    --shadow-1: 0 1px 2px rgba(0,0,0,.35);
    --shadow-2: 0 10px 28px rgba(0,0,0,.45);

    /* Safe area –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    --safe-b: env(safe-area-inset-bottom);
    --safe-t: env(safe-area-inset-top);
    --gap: 12px;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:var(--font-sans);line-height:var(--lh);text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;font-size:16px}
  html{background:var(--bg);color:var(--fg)}
  body{background:var(--bg);color:var(--fg)}
  header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--border);z-index:40}
  .wrap{max-width:1120px;margin:0 auto;padding:14px}
  h1{font-size:var(--fs-h1);font-weight:700;letter-spacing:.1px;margin:var(--space-7) 0 var(--space-3)}
  h3{font-size:var(--fs-h3);font-weight:600;margin:var(--space-5) 0 var(--space-3)}
  .p-lead{font-size:var(--fs-lg);color:var(--muted);margin-bottom:var(--space-5)}
  .text{font-size:var(--fs-md)}
  .text-muted{color:var(--muted)}
  .small{font-size:var(--fs-sm);color:var(--muted)}
  .container{max-width:1040px;margin:0 auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-1);padding:24px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--fg);font-size:var(--fs-md);transition:transform .02s ease,background .15s ease,border-color .15s ease}
  .btn:active{transform:translateY(1px)}
  .btn:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
  .btn-primary{background:var(--accent);color:var(--accent-ink);border-color:transparent;box-shadow:var(--shadow-2)}
  .btn-success{background:var(--ok);color:var(--accent-ink);border-color:transparent}
  .btn-warn{background:var(--warn);color:var(--accent-ink);border-color:transparent}
  .btn-danger{background:var(--err);color:var(--accent-ink);border-color:transparent}
  .input,.select{width:100%;background:var(--bg);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:var(--fs-md)}
  .input::placeholder{color:var(--muted)}
  .input:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
  .select:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
  .nav-item:focus-visible{outline:2px solid var(--accent);outline-offset:2px;border-radius:4px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:20px}
  .col-3{grid-column:span 3}
  .col-4{grid-column:span 4}
  .col-6{grid-column:span 6}
  .col-12{grid-column:1/-1}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:10px;border:1px solid var(--border);border-radius:10px;background:var(--card);background:color-mix(in srgb, var(--card) 90%, #000 10%)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .grow{flex:1}
  select{font-size:14px;border:1px solid var(--border);border-radius:8px;padding:8px 12px;background:var(--card);color:var(--fg);cursor:pointer;min-width:120px;transition:border-color 0.2s}
  select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px color-mix(in srgb, var(--accent) 20%, transparent)}
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:50}
  .overlay.open{display:flex}
  .popup{width:min(100% - 24px,1000px);max-height:86vh;overflow-y:auto;overflow-x:hidden}
  .popheader{position:sticky;top:0;background:var(--card);padding-bottom:8px;margin:-12px -12px 12px -12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;border-radius:var(--radius) var(--radius) 0 0}
  .x{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);background:transparent;border-radius:10px;padding:6px 10px;cursor:pointer}
  .drawer{position:fixed;inset:0;display:none;justify-content:flex-end;align-items:stretch;background:rgba(0,0,0,.35);z-index:60}
  .drawer.open{display:flex}
  .panel{width:min(100%,480px);background:var(--card);border-left:1px solid var(--border);padding:12px;overflow:auto;-webkit-overflow-scrolling:touch}
  .sticky{position:sticky;bottom:0;background:color-mix(in srgb, var(--card) 80%, transparent);backdrop-filter:blur(4px);margin:-12px;border-radius:0 0 var(--radius) var(--radius);padding:10px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;padding-bottom:calc(10px + var(--safe-b))}
  .empty{border:1px dashed var(--border);border-radius:var(--radius);padding:16px;text-align:center;color:var(--muted)}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:10px 12px;opacity:0;transition:opacity .2s;z-index:80}
  .toast.show{opacity:1}
  .history-table-wrapper{overflow-x:auto;margin-bottom:16px;-webkit-overflow-scrolling:touch}
  .history-table{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr;gap:8px;margin-bottom:16px;align-items:center;min-width:800px}
  .history-header{font-weight:600;padding:8px;border-bottom:1px solid var(--border);display:contents}
  .history-header > div{text-align:center}
  .history-row{display:contents}
  .history-row > div{text-align:center;padding:8px}
  #addColumn{cursor:pointer;color:var(--accent)}
  .nav{display:flex;gap:var(--space-2);border-bottom:1px solid var(--border);margin-bottom:var(--space-6)}
  .nav-item{position:relative;padding:var(--space-3) var(--space-4);cursor:pointer;color:var(--muted);transition:color .15s ease}
  .nav-item.active{color:var(--accent);font-weight:600}
  .nav-item.active::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:2px;background:var(--accent)}
  .tab-content{display:none}
  .tab-content.active{display:block}

  /* –¢–∞–±—ã */
  .tabs{display:flex;flex-direction:column;gap:8px;margin-bottom:20px}
  .tab{padding:12px 16px;border:1px solid #7dd3fc;border-radius:8px;background:#e0f2fe;color:#0369a1;font-size:var(--fs-md);cursor:pointer;transition:all 0.15s ease;text-align:left;width:100%}
  .tab:hover{background:#b3e5fc;color:#01579b}
  .tab.active{background:#0284c7;color:#f0f9ff;border-color:#0284c7;font-weight:600}
  /* –ú–æ–±–∏–ª—å–Ω—ã–µ –º–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å—ã */
  @media(max-width:1024px){
    .col-3{grid-column:span 4}
    .col-6{grid-column:span 8}
  }
  @media(max-width:640px){
    .col-3{grid-column:1/-1}
    .col-6{grid-column:1/-1}
    .container{padding:0 16px}
    .wrap{padding:16px}
    .card{padding:16px}
    .tabs{flex-direction:column;gap:6px}
    .tab{font-size:13px;padding:10px 14px}
  }
  @media(max-width:480px){
    .container{padding:0 12px}
    .wrap{padding:12px}
    .card{padding:12px}
    header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--border);z-index:40;padding-top:var(--safe-t)}
    .grid{gap:12px}
    .popup{width:calc(100% - 16px);max-height:calc(100vh - var(--safe-t) - var(--safe-b) - 48px);overflow-y:auto;overflow-x:hidden}
    .panel{width:100%;padding-bottom:calc(12px + var(--safe-b))}
    .sticky{padding-bottom:calc(10px + var(--safe-b))}
    .toast{bottom:calc(16px + var(--safe-b))}
    .menu{flex-wrap:wrap;gap:4px}
    .menu button{font-size:13px;padding:8px 10px}
    .menu .pill{font-size:11px;padding:4px 8px}
    .history-table{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr;gap:4px;font-size:12px;min-width:600px}
    .history-table .history-header > div,.history-table .history-row > div{padding:4px}
    .history-table-wrapper{overflow-x:auto;-webkit-overflow-scrolling:touch}
    .row{gap:8px}
    .item{padding:8px;gap:8px}
    .list{gap:6px}
  }
  @media(max-width:480px){
    .tabs{flex-direction:column;gap:6px}
    .tab{font-size:13px;padding:10px 14px}
    /* Touch-friendly —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    .btn,input[type="button"],input[type="submit"],button,select{min-height:44px;min-width:44px}
    .btn{font-size:14px;padding:10px 12px}
  }
</style>
<body>
<header class="header">
  <div class="wrap">
    <h1>–¢—Ä–µ–∫–µ—Ä —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h1>
    <div style="background: var(--ok); color: var(--accent-ink); padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-bottom: 8px; display: inline-block;">
      üî• –û–ë–ù–û–í–õ–ï–ù–û: 2025-10-30 13:10 - Previous Workout –∏—Å–ø—Ä–∞–≤–ª–µ–Ω!
    </div>
    <div class="menu">
      <button class="btn" data-open="plan">
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z" fill="none" stroke="currentColor" stroke-width="2"/>
          <polyline points="14,2 14,8 20,8" fill="none" stroke="currentColor" stroke-width="2"/>
          <line x1="16" y1="13" x2="8" y2="13" fill="none" stroke="currentColor" stroke-width="2"/>
          <line x1="16" y1="17" x2="8" y2="17" fill="none" stroke="currentColor" stroke-width="2"/>
          <polyline points="10,9 9,9 8,9" fill="none" stroke="currentColor" stroke-width="2"/>
        </svg>
        –ü–ª–∞–Ω
      </button>
      <button class="btn" data-open="exercises">
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="none" stroke="currentColor" stroke-width="2"/>
        </svg>
        –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
      </button>
      <button class="btn" data-open="measurements">
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M21 21V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14" fill="none" stroke="currentColor" stroke-width="2"/>
          <path d="M3 21h18" fill="none" stroke="currentColor" stroke-width="2"/>
          <path d="M7 12v9" fill="none" stroke="currentColor" stroke-width="2"/>
          <path d="M11 12v9" fill="none" stroke="currentColor" stroke-width="2"/>
          <path d="M15 12v9" fill="none" stroke="currentColor" stroke-width="2"/>
          <path d="M19 12v9" fill="none" stroke="currentColor" stroke-width="2"/>
        </svg>
        –ò—Å—Ç–æ—Ä–∏—è
      </button>
      <button class="btn" data-open="nutrition">
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2" fill="none" stroke="currentColor" stroke-width="2"/>
          <path d="M7 2v20" fill="none" stroke="currentColor" stroke-width="2"/>
          <path d="M21 15V2v13a2 2 0 0 1-2 2H9" fill="none" stroke="currentColor" stroke-width="2"/>
        </svg>
        –ü–∏—Ç–∞–Ω–∏–µ
      </button>
      <button class="btn" data-open="settings">
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" fill="none" stroke="currentColor" stroke-width="2"/>
        </svg>
        –ù–∞—Å—Ç—Ä–æ–π–∫–∏
      </button>
      <span class="pill">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <b id="userLabel">‚Äî</b></span>
      <span class="pill">–¢–µ–º–∞: <b id="themeLabel">–¢—ë–º–Ω–∞—è</b></span>
    </div>
  </div>
</header>

<main class="container">
  <div class="grid">
    <div class="col-3">
      <section class="card">
        <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h3>
        <p class="text-muted">–¢—Ä–µ–∫–µ—Ä —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ JSON.</p>

        <div class="tabs" style="margin-top: var(--space-6);">
          <button class="tab active" data-tab="tab-overview" aria-selected="true">–û–±–∑–æ—Ä</button>
          <button class="tab" data-tab="tab-stats" aria-selected="false">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
          <button class="tab" data-tab="tab-history" aria-selected="false">–ò—Å—Ç–æ—Ä–∏—è</button>
        </div>

        <div id="tab-overview" class="tab-content active">
          <p class="text">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ.</p>
        </div>

        <div id="tab-stats" class="tab-content">
          <p class="text-muted">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π.</p>
          <div class="row" style="margin-top: 12px; gap: 12px;">
            <div style="text-align: center;">
              <div class="text-muted small">–í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
              <div style="font-size: var(--fs-h2); font-weight: 700;">24</div>
            </div>
            <div style="text-align: center;">
              <div class="text-muted small">–†–µ–∫–æ—Ä–¥—ã</div>
              <div style="font-size: var(--fs-h2); font-weight: 700; color: var(--ok);">8</div>
            </div>
          </div>
        </div>

        <div id="tab-history" class="tab-content">
          <p class="text-muted">–ò—Å—Ç–æ—Ä–∏—è –≤–∞—à–∏—Ö –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π.</p>
          <div class="list" style="margin-top: 12px;">
            <div class="item">
              <div><b>–ü—Ä–∏—Å–µ–¥</b><div class="small text-muted">70 –∫–≥ √ó 4 –ø–æ–¥—Ö–æ–¥–∞</div></div>
              <span class="tag">–ù–æ–≥–∏</span>
            </div>
            <div class="item">
              <div><b>–ñ–∏–º –ª–µ–∂–∞</b><div class="small text-muted">60 –∫–≥ √ó 4 –ø–æ–¥—Ö–æ–¥–∞</div></div>
              <span class="tag">–ì—Ä—É–¥—å</span>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="col-6">
      <section class="card">
        <div class="section-title">
          <h2>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
        </div>
        <div class="list">
          <div class="item">
            <div>
              üìÖ
              <b>–ü–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</b>
              <div class="small text-muted">–°–æ–∑–¥–∞–π—Ç–µ –ø–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
            <button class="btn btn-primary" data-open="plan">–°–æ–∑–¥–∞—Ç—å</button>
          </div>
          <div class="item">
            <div>
              üìä
              <b>–ó–∞–º–µ—Ä—ã</b>
              <div class="small text-muted">–û–±–Ω–æ–≤–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ–ª–∞</div>
            </div>
            <button class="btn btn-primary" data-open="measurements">–î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
          <div class="item">
            <div>
              ü•ó
              <b>–ü–∏—Ç–∞–Ω–∏–µ</b>
              <div class="small text-muted">–ó–∞–ø–∏—à–∏—Ç–µ –ø—Ä–∏—ë–º –ø–∏—â–∏</div>
            </div>
            <button class="btn btn-primary" data-open="nutrition">–í–≤–µ—Å—Ç–∏</button>
          </div>
        </div>
      </section>
    </div>

    <div class="col-3">
      <section class="card">
        <div class="section-title">
          <h2>–ü—Ä–æ–≥—Ä–µ—Å—Å</h2>
        </div>
        <div class="list">
          <div class="item">
            <div>
              <svg class="icon" width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" style="margin-right: 8px; color: var(--ok);">
                <polyline points="22,12 18,12 15,21 9,3 6,12 2,12" fill="none" stroke="currentColor" stroke-width="2"/>
              </svg>
              <b>–¢—Ä–µ–Ω–¥ –≤–≤–µ—Ä—Ö</b>
              <div class="small text-muted">+2.5 –∫–≥ –≤ –∂–∏–º–µ</div>
            </div>
            <span class="tag" style="background: var(--ok); color: var(--accent-ink);">+PR</span>
          </div>
          <div class="item">
            <div>
              <svg class="icon" width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" style="margin-right: 8px; color: var(--warn);">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="none" stroke="currentColor" stroke-width="2"/>
              </svg>
              <b>–¶–µ–ª—å –±–ª–∏–∑–∫–æ</b>
              <div class="small text-muted">–û—Å—Ç–∞–ª–æ—Å—å 2 –∫–≥ –¥–æ —Ü–µ–ª–∏</div>
            </div>
            <span class="tag">–¶–µ–ª—å</span>
          </div>
          <div class="item">
            <div>
              <svg class="icon" width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" style="margin-right: 8px; color: var(--err);">
                <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                <line x1="15" y1="9" x2="9" y2="15" fill="none" stroke="currentColor" stroke-width="2"/>
                <line x1="9" y1="9" x2="15" y2="15" fill="none" stroke="currentColor" stroke-width="2"/>
              </svg>
              <b>–ü—Ä–æ–ø—É—Å–∫</b>
              <div class="small text-muted">2 –¥–Ω—è –±–µ–∑ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>
            </div>
            <span class="tag" style="background: var(--err); color: var(--accent-ink);">–ü—Ä–æ–ø—É—Å–∫</span>
          </div>
        </div>
      </section>
    </div>
  </div>
</main>

<!-- PLAN -->
<div class="overlay" id="ov-plan" data-overlay>
  <div class="popup card">
    <div class="popheader">
      <div>
        <h2>–ü–ª–∞–Ω</h2>
        <div class="small text-muted" id="lastWorkoutInfo" style="margin-top: 4px;">‚Äî</div>
      </div>
      <button class="btn" data-close aria-label="–ó–∞–∫—Ä—ã—Ç—å">
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18" fill="none" stroke="currentColor" stroke-width="2"/>
          <line x1="6" y1="6" x2="18" y2="18" fill="none" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
    </div>
    <div class="row" style="margin-bottom:8px">
      <span class="pill" id="prevWorkout" style="cursor:pointer;" data-open="prev-workout">–ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–∞–Ω—è—Ç–∏–µ: <b>‚Äî</b></span>
    </div>
    <div class="card" style="margin-bottom:10px">
      <div class="row">
        <label class="pill">–î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–Ω—è—Ç–∏—è
          <input id="planDate" type="date" class="input">
        </label>
        <label class="pill">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –¥–µ–Ω—å —Ü–∏–∫–ª–∞
          <select id="daySel" class="select">
            <option value="1">1 ‚Äî –ù–æ–≥–∏/–ü–ª–µ—á–∏</option>
            <option value="2">2 ‚Äî –ì—Ä—É–¥—å/–ë–∏—Ü–µ–ø—Å</option>
            <option value="3">3 ‚Äî –°–ø–∏–Ω–∞/–¢—Ä–∏—Ü–µ–ø—Å</option>
          </select>
        </label>
        <button class="btn btn-primary" id="btnGen">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>

    <div id="planArea" class="list">
      <div class="empty">–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –ø–ª–∞–Ω, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.</div>
    </div>

    <div class="row" style="margin:12px 0 0">
      <button class="btn" id="btnEditMain">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é</button>
      <button class="btn" id="btnEditAux">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é</button>
      <button class="btn" id="btnEditCool">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–∏–Ω–∫—É</button>
      <button class="btn" id="btnAddWeight">–î–æ–±–∞–≤–∏—Ç—å –≤–µ—Å</button>
      <div class="grow"></div>
      <button class="btn btn-primary" id="btnSave" disabled>–û—Ç–º–µ—Ç–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
    </div>
  </div>
</div>

<!-- Drawer -->
<div class="drawer" id="drawer">
  <div class="panel card">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 id="drTitle">–†–µ–¥–∞–∫—Ç–æ—Ä</h3>
      <button class="btn" id="drClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18" fill="none" stroke="currentColor" stroke-width="2"/>
          <line x1="6" y1="6" x2="18" y2="18" fill="none" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
    </div>
    <div class="row" style="margin-bottom:8px">
      <span class="pill">–ì—Ä—É–ø–ø–∞: <b id="drGroup">‚Äî</b></span>
      <span class="pill">–í—ã–±—Ä–∞–Ω–æ: <b id="drSel">0</b></span>
      <span class="pill">–ù—É–∂–Ω–æ: <b id="drNeed">0</b></span>
    </div>
    <div id="drList" class="list" style="margin-bottom:10px"></div>
    <div class="sticky">
      <button class="btn btn-primary" id="drApply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- ADD WEIGHT -->
<div class="overlay" id="ov-add" data-overlay>
  <div class="popup card">
    <div class="popheader">
      <h2>–î–æ–±–∞–≤–∏—Ç—å –≤–µ—Å (PR)</h2>
      <button class="btn" data-close aria-label="–ó–∞–∫—Ä—ã—Ç—å">
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18" fill="none" stroke="currentColor" stroke-width="2"/>
          <line x1="6" y1="6" x2="18" y2="18" fill="none" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
    </div>
    <div class="list">
      <div class="item">
        <div>–ì—Ä—É–ø–ø–∞</div>
        <select id="awGroup" class="select">
          <option>–ù–æ–≥–∏</option><option>–ì—Ä—É–¥—å</option><option>–°–ø–∏–Ω–∞</option>
          <option>–ü–ª–µ—á–∏</option><option>–ë–∏—Ü–µ–ø—Å</option><option>–¢—Ä–∏—Ü–µ–ø—Å</option>
        </select>
      </div>
      <div class="item">
        <div>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</div>
        <select id="awExercise" class="select"></select>
      </div>
      <div class="item">
        <div class="grow">
          <div class="muted">–ü—Ä–µ–¥—ã–¥—É—â–∏–π PR: <b id="awPrev">‚Äî</b></div>
          <div class="muted">–î–∞—Ç–∞ PR: <b id="awPrevDate">‚Äî</b></div>
        </div>
        <div>
          <button class="btn" id="awMinus">‚àí2.5</button>
          <span class="pill">Œî: <b id="awDelta">0</b> –∫–≥</span>
          <button class="btn" id="awPlus">+2.5</button>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn btn-primary" id="awApply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- EXERCISES -->
<div class="overlay" id="ov-exercises" data-overlay>
  <div class="popup card">
    <div class="popheader">
      <h2>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h2>
      <button class="btn" data-close aria-label="–ó–∞–∫—Ä—ã—Ç—å">
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18" fill="none" stroke="currentColor" stroke-width="2"/>
          <line x1="6" y1="6" x2="18" y2="18" fill="none" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
    </div>
    <div class="row" style="margin-bottom:8px">
      <select id="exGroup" class="select">
        <option>–ù–æ–≥–∏</option><option>–ì—Ä—É–¥—å</option><option>–°–ø–∏–Ω–∞</option>
        <option>–ü–ª–µ—á–∏</option><option>–ë–∏—Ü–µ–ø—Å</option><option>–¢—Ä–∏—Ü–µ–ø—Å</option>
      </select>
      <input id="exSearch" class="input" placeholder="–ü–æ–∏—Å–∫‚Ä¶">
    </div>
    <div id="exList" class="list"></div>
  </div>
</div>

<!-- NUTRITION -->
<div class="overlay" id="ov-nutrition" data-overlay>
  <div class="popup card">
    <div class="popheader">
      <h2>–ü–∏—Ç–∞–Ω–∏–µ</h2>
      <button class="btn" data-close aria-label="–ó–∞–∫—Ä—ã—Ç—å">
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18" fill="none" stroke="currentColor" stroke-width="2"/>
          <line x1="6" y1="6" x2="18" y2="18" fill="none" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
    </div>
    <div id="nutritionArea"></div>
  </div>
</div>

<!-- MEASUREMENTS -->
<div class="overlay" id="ov-measurements" data-overlay>
  <div class="popup card">
    <div class="popheader">
      <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
      <button class="btn" data-close aria-label="–ó–∞–∫—Ä—ã—Ç—å">
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18" fill="none" stroke="currentColor" stroke-width="2"/>
          <line x1="6" y1="6" x2="18" y2="18" fill="none" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
    </div>
    <div id="measurementsArea"></div>
  </div>
</div>

<!-- SETTINGS -->
<div class="overlay" id="ov-settings" data-overlay>
  <div class="popup card">
    <div class="popheader">
      <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <button class="btn" data-close aria-label="–ó–∞–∫—Ä—ã—Ç—å">
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18" fill="none" stroke="currentColor" stroke-width="2"/>
          <line x1="6" y1="6" x2="18" y2="18" fill="none" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
    </div>
    <div class="list">
      <div class="item">
        <div>–ü—Ä–æ—Ñ–∏–ª—å</div>
        <div class="row">
          <div class="form-group" style="flex: 1;">
            <label class="form-label" for="userName">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input id="userName" class="input" placeholder="–ê–Ω—Ç–æ–Ω">
            <div class="form-help">–í–∞—à–µ –∏–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</div>
          </div>
          <div class="form-group" style="flex: 1;">
            <label class="form-label" for="userEmail">Email</label>
            <input id="userEmail" type="email" class="input" placeholder="email@example.com">
            <div class="form-help">–î–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</div>
          </div>
        </div>
      </div>
      <div class="item">
        <div>–¢–µ–º–∞</div>
        <div class="row">
          <select id="themeSel" class="select">
            <option value="dark">–¢—ë–º–Ω–∞—è</option>
            <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
          </select>
          <button class="btn" id="themeToggle" style="margin-left:8px">üîÑ</button>
        </div>
      </div>
      <div class="item">
        <div>–î–∞–Ω–Ω—ã–µ</div>
        <div class="row">
          <button class="btn btn-primary" id="btnExport">üìÅ –°–∫–∞—á–∞—Ç—å JSON</button>
          <button class="btn btn-success" onclick="toast('–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!')">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn btn-warn" onclick="toast('–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ')">‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å</button>
          <button class="btn btn-danger" onclick="confirm('–£–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ?') || toast('–û—Ç–º–µ–Ω–µ–Ω–æ')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- VIEW PREVIOUS WORKOUT -->
<div class="overlay" id="ov-prev-workout" data-overlay>
  <div class="popup card">
    <div class="popheader">
      <h2 id="prevWorkoutTitle">–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h2>
      <button class="btn" data-close aria-label="–ó–∞–∫—Ä—ã—Ç—å">
        <svg class="icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18" fill="none" stroke="currentColor" stroke-width="2"/>
          <line x1="6" y1="6" x2="18" y2="18" fill="none" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
    </div>
    <div class="row" style="margin-bottom:8px">
      <span class="pill" id="prevWorkoutInfo">‚Äî</span>
    </div>
    <div id="prevWorkoutArea" class="list">
      <div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏...</div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:16px">
      <button class="btn" id="btnCancelPrevChanges" style="margin-right:8px">–û—Ç–º–µ–Ω–∏—Ç—å</button>
      <button class="btn btn-primary" id="btnSavePrevChanges">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
"use strict";
const $ = (id)=>document.getElementById(id);
const fmt = (d)=> new Date(d).toLocaleDateString('ru-RU');
function isoDateOnly(d){ const dt=new Date(d); const y=dt.getFullYear(); const m=("0"+(dt.getMonth()+1)).slice(-2); const da=("0"+dt.getDate()).slice(-2); return `${y}-${m}-${da}`; }
function todayISO(){ return isoDateOnly(new Date()); }
function toast(msg){ const t=$("toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1200); }

/* DB */
let DB = { user:{name:"–ê–Ω—Ç–æ–Ω", theme:"dark"}, exercises:[], workouts:[], measurements:[], nutrition:[] };
let loadedMeasurements = []; // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
let loadedNutrition = []; // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–∏—Ç–∞–Ω–∏—è
let measurementsList = [
  {key:"waist", label:"–¢–∞–ª–∏—è"},
  {key:"chest_back", label:"–°–ø–∏–Ω–∞‚Äì–≥—Ä—É–¥—å"},
  {key:"arm_r", label:"–†—É–∫–∞ –ø—Ä–∞–≤–∞—è"},
  {key:"arm_l", label:"–†—É–∫–∞ –ª–µ–≤–∞—è"},
  {key:"thigh_r", label:"–ë–µ–¥—Ä–æ –ø—Ä–∞–≤–æ–µ"},
  {key:"thigh_l", label:"–ë–µ–¥—Ä–æ –ª–µ–≤–æ–µ"},
  {key:"forearm_r", label:"–ü—Ä–µ–¥–ø–ª–µ—á—å–µ –ø—Ä–∞–≤–æ–µ"},
  {key:"forearm_l", label:"–ü—Ä–µ–¥–ø–ª–µ—á—å–µ –ª–µ–≤–æ–µ"}
];
let nutritionList = [
  {key:"calories", label:"–ö–∞–ª–æ—Ä–∏–∏"},
  {key:"steps", label:"–®–∞–≥–∏"},
  {key:"weight", label:"–í–µ—Å"}
];

async function loadDB(){
  console.log("üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firebase (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)...");

  try {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ userId, —á—Ç–æ –∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
    const userId = DB.user.name || "user123";
    const docRef = await firebase.firestore().collection("measurements").doc(userId).get();

    if (docRef.exists) {
      const data = docRef.data();
      console.log("üìã –î–∞–Ω–Ω—ã–µ –∏–∑ Firebase:", data);

      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
      DB.measurements = [];
      loadedMeasurements = [];

      // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–ª–æ–Ω–æ–∫ –∑–∞–º–µ—Ä–æ–≤
      for (let i = 1; i <= 4; i++) {
        const colKey = `col${i}`;
        const columnData = data[colKey];

        if (columnData && columnData.date) {
          DB.measurements.push(columnData);
          loadedMeasurements.push(columnData);
          console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –∑–∞–º–µ—Ä–æ–≤ ${i}:`, columnData);
        } else {
          console.log(`‚ö™ –ö–æ–ª–æ–Ω–∫–∞ –∑–∞–º–µ—Ä–æ–≤ ${i}: –ø—É—Å—Ç–∞—è`);
        }
      }

      // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–ª–æ–Ω–æ–∫ –ø–∏—Ç–∞–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
      DB.nutrition = [];
      loadedNutrition = [];
      for (let i = 1; i <= 4; i++) {
        const colKey = `nutrition_col${i}`;
        const columnData = data[colKey];

        if (columnData && columnData.date) {
          DB.nutrition.push(columnData);
          loadedNutrition.push(columnData);
          console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –ø–∏—Ç–∞–Ω–∏—è ${i}:`, columnData);
        } else {
          console.log(`‚ö™ –ö–æ–ª–æ–Ω–∫–∞ –ø–∏—Ç–∞–Ω–∏—è ${i}: –ø—É—Å—Ç–∞—è`);
        }
      }

      console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${DB.measurements.length} –∫–æ–ª–æ–Ω–æ–∫ –∑–∞–º–µ—Ä–æ–≤ –∏ ${DB.nutrition.length} –∫–æ–ª–æ–Ω–æ–∫ –ø–∏—Ç–∞–Ω–∏—è –∏–∑ Firebase`);
      toast(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${DB.measurements.length} –∑–∞–º–µ—Ä–æ–≤ –∏ ${DB.nutrition.length} –∑–∞–ø–∏—Å–µ–π –ø–∏—Ç–∞–Ω–∏—è`);
    } else {
      console.log("üìã –î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Firebase - —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É");
      DB.measurements = [];
      loadedMeasurements = [];
      DB.nutrition = [];
      loadedNutrition = [];
      toast("–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö");
    }

  } catch(e) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:", e);
    toast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase");
    DB.measurements = [];
    loadedMeasurements = [];
    DB.nutrition = [];
    loadedNutrition = [];
  }

  // –°–æ–∑–¥–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç —Å –ø—É—Å—Ç–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  if (DB.measurements.length === 0 && DB.nutrition.length === 0) {
    console.log("üìã –°–æ–∑–¥–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç —Å –ø—É—Å—Ç–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –≤ Firebase");
    try {
      const userId = DB.user.name || "user123";
      const docRef = firebase.firestore().collection("measurements").doc(userId);

      await docRef.set({
        col1: null,
        col2: null,
        col3: null,
        col4: null,
        nutrition_col1: null,
        nutrition_col2: null,
        nutrition_col3: null,
        nutrition_col4: null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      console.log(`‚úÖ –°–æ–∑–¥–∞–Ω –ø—É—Å—Ç–æ–π –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`);
    } catch(e) {
      console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:", e);
    }
  }
}

async function saveDB(){
  console.log("üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ Firebase...");
  const measurementsToSave = DB.measurements.filter(m => !loadedMeasurements.some(lm => lm.date === m.date && JSON.stringify(lm) === JSON.stringify(m)));
  
  if (measurementsToSave.length === 0) {
    console.log("‚ÑπÔ∏è –ù–µ—Ç –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
    toast("–ù–µ—Ç –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö");
    return;
  }

  console.log(`üì§ –°–æ—Ö—Ä–∞–Ω—è–µ–º ${measurementsToSave.length} –Ω–æ–≤—ã—Ö –∑–∞–º–µ—Ä–æ–≤`);
  
  try{
    for (const measurement of measurementsToSave) {
      const docRef = await firebase.firestore().collection("measurements").add(measurement);
      console.log(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω –∑–∞–º–µ—Ä ${measurement.date} —Å ID: ${docRef.id}`);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º loadedMeasurements
    loadedMeasurements.push(...measurementsToSave);
    console.log(`‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Firebase (${measurementsToSave.length} –∑–∞–º–µ—Ä–æ–≤)`);
    toast(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${measurementsToSave.length} –∑–∞–º–µ—Ä–æ–≤ –≤ Firebase`);
  }catch(e){
    console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firebase:", e);
    // Fallback: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
    localStorage.setItem("ft_front_db_v2", JSON.stringify(DB));
    toast("–û—à–∏–±–∫–∞ Firebase ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ");
  }
}

/* Seed demo exercises + measurements */
async function loadExercisesFromJSON(){
  try{
    const response = await fetch('./reference_normalized (1).json');
    const data = await response.json();
    const exercisesByGroup = {};
    data.records.forEach(record => {
      const { group, number, name, value, date } = record;
      if (!exercisesByGroup[group]) exercisesByGroup[group] = {};
      if (!exercisesByGroup[group][number]) exercisesByGroup[group][number] = { name, values: [], dates: [] };
      exercisesByGroup[group][number].values.push(value);
      exercisesByGroup[group][number].dates.push(date);
    });
    DB.exercises = []; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    for (const group of Object.keys(exercisesByGroup)){
      const nums = Object.keys(exercisesByGroup[group]).sort((a,b)=>a-b); // –ë–µ—Ä–µ–º –≤—Å–µ –Ω–æ–º–µ—Ä–∞
      for (const num of nums){
        if (group === "–ù–æ–≥–∏" && num === 10) continue; // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –Ω–æ–º–µ—Ä 10 –¥–ª—è –Ω–æ–≥
        const ex = exercisesByGroup[group][num];
        const maxValue = Math.max(...ex.values);
        const lastDate = ex.dates[ex.values.indexOf(maxValue)];
        if (maxValue > 0 && lastDate) { // –§–∏–ª—å—Ç—Ä—É–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –±–µ–∑ PR –∏–ª–∏ –¥–∞—Ç—ã
          DB.exercises.push({
            id: (ex.name.toLowerCase() + "__" + group + "__" + num), // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π id —Å –Ω–æ–º–µ—Ä–æ–º
            name: ex.name,
            group: group,
            pr: maxValue,
            lastDate: lastDate
          });
        }
      }
    }
  } catch(e){
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSON:", e);
    toast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON");
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –∏–∑ Firebase
async function loadExercisesCache() {
  try {
    console.log('üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—ç—à —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –∏–∑ Firebase...');
    const exercisesRef = firebase.firestore().collection('exercises');
    const snapshot = await exercisesRef.get();

    DB.exercises = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      DB.exercises.push({
        id: doc.id,
        name: data.name,
        group: data.group,
        pr: data.pr_weight || 0,
        lastDate: data.pr_date
      });
    });

    console.log('üìã –í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–∑ Firebase:', DB.exercises.map(ex => ({name: ex.name, id: ex.id})));
    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${DB.exercises.length} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤ –∫—ç—à`);
    return DB.exercises;
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—ç—à–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π:', error);
    // Fallback: –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ JSON
    await loadExercisesFromJSON();
    return DB.exercises;
  }
}

function seedIfEmpty(){
  if(!DB.exercises.length){
    loadExercisesFromJSON(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ JSON –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
  }
  // –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—É—é —Ç–∞–±–ª–∏—Ü—É –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firebase
  console.log(`üìä –î–æ—Å—Ç—É–ø–Ω–æ –∑–∞–º–µ—Ä–æ–≤: ${DB.measurements.length}`);
}

/* Theme & User */
const root = document.documentElement;
const saved = localStorage.getItem('theme');
const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
root.setAttribute('data-theme', saved ?? (prefersDark ? 'dark' : 'light'));

function applyTheme(){
  const currentTheme = root.getAttribute('data-theme');
  DB.user.theme = currentTheme;
  localStorage.setItem('theme', currentTheme);
  $("themeLabel").textContent = currentTheme==="light"?"–°–≤–µ—Ç–ª–∞—è":"–¢—ë–º–Ω–∞—è";
}
function syncUserUI(){
  $("userLabel").textContent=DB.user.name||"‚Äî";
  $("userName").value=DB.user.name||"";
  const currentTheme = root.getAttribute('data-theme');
  $("themeSel").value=currentTheme;
  DB.user.theme = currentTheme;
  applyTheme();
}

document.getElementById('themeSel').addEventListener('change', () => {
  const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
  root.setAttribute('data-theme', next);
  DB.user.theme = next;
  localStorage.setItem('theme', next);
  syncUserUI();
});

/* Tab Navigation */
function initTabs(){
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // Remove active state from all tabs
      tabs.forEach(t => {
        t.setAttribute('aria-selected', 'false');
        t.classList.remove('active');
      });

      // Set active state on clicked tab
      tab.setAttribute('aria-selected', 'true');
      tab.classList.add('active');

      // Show corresponding tab content
      const tabId = tab.getAttribute('data-tab');
      const contents = document.querySelectorAll('.tab-content');
      contents.forEach(content => {
        content.classList.remove('active');
        if(content.id === tabId) {
          content.classList.add('active');
        }
      });
    });
  });
}

/* Plan state */
const CYCLE={1:{main:"–ù–æ–≥–∏",aux:"–ü–ª–µ—á–∏"},2:{main:"–ì—Ä—É–¥—å",aux:"–ë–∏—Ü–µ–ø—Å"},3:{main:"–°–ø–∏–Ω–∞",aux:"–¢—Ä–∏—Ü–µ–ø—Å"}};
let PLAN=null;
async function lastWorkout(){
  try {
    console.log('üîç –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –∏–∑ Firebase...');

    // –ó–∞–ø—Ä–æ—Å –∫ Firebase: workoutLog, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ message_id DESC, limit(1)
    const workoutLogRef = firebase.firestore().collection('workoutLog');
    const snapshot = await workoutLogRef
      .orderBy('message_id', 'desc')
      .limit(1)
      .get();

    if (!snapshot.empty) {
      const doc = snapshot.docs[0];
      const workoutData = doc.data();
      console.log('‚úÖ –ù–∞–π–¥–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞:', workoutData.date, workoutData.groups);
      return workoutData;
    } else {
      console.log('‚ö†Ô∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ Firebase, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
      // Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      if (DB.workouts && DB.workouts.length > 0) {
        return DB.workouts.slice().sort((a,b)=> new Date(b.date)-new Date(a.date))[0];
      }
      return null;
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:', error);
    // Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    if (DB.workouts && DB.workouts.length > 0) {
      return DB.workouts.slice().sort((a,b)=> new Date(b.date)-new Date(a.date))[0];
    }
    return null;
  }
}
async function suggestedDay(){
  const lw = await lastWorkout();
  if (!lw) return 1;
  // –ü–æ—Å–ª–µ –¥–Ω—è 3 –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –¥–Ω—é 1, –∏–Ω–∞—á–µ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
  return lw.day >= 3 ? 1 : lw.day + 1;
}

async function setPrevWorkoutLabel(){
  const lw = await lastWorkout();
  PREV_WORKOUT = lw;
  const groupsText = lw ? lw.groups : "‚Äî";
  const dayText = lw ? `–î–µ–Ω—å ${lw.day}` : "‚Äî";
  const dateText = lw ? fmt(lw.date) : "‚Äî";

  const prevWorkoutBtn = $('prevWorkout');
  if (prevWorkoutBtn) {
    if (lw) {
      prevWorkoutBtn.innerHTML = `–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: <b>${dateText} ¬∑ ${dayText} (${groupsText})</b><br><small style="color:var(--muted);">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å PR</small>`;
    } else {
      prevWorkoutBtn.innerHTML = `–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: <b>–Ω–µ –Ω–∞–π–¥–µ–Ω–∞</b><br><small style="color:var(--muted);">–í—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–µ–¥—ã–¥—É—â—É—é</small>`;
    }
  }

  const lastWorkoutInfo = $('lastWorkoutInfo');
  if (lastWorkoutInfo && lw) {
    lastWorkoutInfo.textContent = `–ü–æ—Å–ª–µ–¥–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: ${fmt(lw.date)} ¬∑ –î–µ–Ω—å ${lw.day} (${lw.groups})`;
  } else if (lastWorkoutInfo) {
    lastWorkoutInfo.textContent = "–ü–æ—Å–ª–µ–¥–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞";
  }
}

async function setInitPlanHeader(){
  $("planDate").value = todayISO();
  const suggested = await suggestedDay();
  $("daySel").value = String(suggested);
}

function defaultCooldown(day){ return day===1?["–ü–ª–∞–Ω–∫–∞/–∫–æ—Ä","–ü—Ä–µ—Å—Å"]:(day===2?["–ú–§–†/—Ä–æ–ª–∏–∫","–ü–æ–¥–≤–∏–∂–Ω–æ—Å—Ç—å –ø–ª–µ—á"]:["–•–≤–∞—Ç/–≤–∏—Å","–û—Å–∞–Ω–∫–∞/–º–æ–±–∏–ª–∏—Ç–∏"]); }

function planGenerate(){
  const day=Number($("daySel").value); const dateISO=$("planDate").value||todayISO();
  const mainGroup=CYCLE[day].main, auxGroup=CYCLE[day].aux;
  const exMain = DB.exercises.filter(e=> e.group===mainGroup).slice(0,3);
  const exAux  = DB.exercises.filter(e=> e.group===auxGroup).slice(0,2);
  PLAN = {
    dateISO, day, mainGroup, auxGroup,
    main: exMain.map(e=> ({exId:e.id, name:e.name, sets:4, pr:(e.pr==null?0:e.pr)})),
    aux:  exAux.map(e=> ({exId:e.id, name:e.name, sets:4, pr:(e.pr==null?0:e.pr)})),
    cooldown: defaultCooldown(day),
    increments:{}
  };
  renderPlanArea(); $("btnSave").disabled=false; toast("–ü–ª–∞–Ω —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω");
}

function renderPlanArea(){
  const box=$("planArea");
  if(!PLAN){ box.innerHTML='<div class="empty">–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –ø–ª–∞–Ω, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.</div>'; return; }
  const makeRow=(it)=>{
    const ex=DB.exercises.find(x=> x.id===it.exId);
    const base = (typeof it.pr==="number")? it.pr : (typeof ex?.pr==="number"? ex.pr : 0);
    const inc = PLAN.increments[it.exId]||0;
    const shown = base + (inc? inc:0);
    const row=document.createElement("div"); row.className="item";
    row.innerHTML = `<div><b>${it.name}</b><div class="muted">${it.sets} –ø–æ–¥—Ö–æ–¥–∞ ¬∑ PR: <b>${(base||0)} –∫–≥</b></div></div>`;
    const right=document.createElement("div");
    right.innerHTML = `<span class="tag">–ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é: ${shown} –∫–≥</span> <button class="btn plus">+2.5</button>`;
    right.querySelector(".plus").addEventListener("click", ()=>{ PLAN.increments[it.exId]=(PLAN.increments[it.exId]||0)+2.5; renderPlanArea(); });
    row.appendChild(right); return row;
  };
  box.innerHTML="";
  const h1=document.createElement("div"); h1.className="muted"; h1.textContent="–û—Å–Ω–æ–≤–Ω—ã–µ (3)"; box.appendChild(h1);
  PLAN.main.forEach(it=> box.appendChild(makeRow(it)));
  const h2=document.createElement("div"); h2.className="muted"; h2.style.marginTop="6px"; h2.textContent="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ (2‚Ä¶3)"; box.appendChild(h2);
  PLAN.aux.forEach(it=> box.appendChild(makeRow(it)));
  const h3=document.createElement("div"); h3.className="muted"; h3.style.marginTop="6px"; h3.textContent="–ó–∞–º–∏–Ω–∫–∞ (2)"; box.appendChild(h3);
  PLAN.cooldown.forEach(n=>{ const row=document.createElement("div"); row.className="item"; row.innerHTML = `<div><b>${n}</b><div class="muted">–±–µ–∑ –≤–µ—Å–æ–≤</div></div>`; box.appendChild(row); });
}

/* Drawer editors */
let DR={role:null,need:0,group:null};
function openDrawer(role){
  if(!PLAN){ toast("–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –ø–ª–∞–Ω"); return; }
  DR.role=role; const isMain=role==="main"; DR.group=isMain?PLAN.mainGroup:(role==="aux"?PLAN.auxGroup:"–ó–∞–º–∏–Ω–∫–∞"); DR.need=role==="cool"?2:(isMain?3:2);
  $("drTitle").textContent = isMain? "–†–µ–¥–∞–∫—Ç–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–π" : (role==="aux"?"–†–µ–¥–∞–∫—Ç–æ—Ä –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π":"–†–µ–¥–∞–∫—Ç–æ—Ä –∑–∞–º–∏–Ω–∫–∏");
  $("drGroup").textContent=DR.group; $("drNeed").textContent=DR.need;
  const list=$("drList"); list.innerHTML="";
  if(role==="cool"){
    const options=["–ü–ª–∞–Ω–∫–∞/–∫–æ—Ä","–ü—Ä–µ—Å—Å","–ú–§–†/—Ä–æ–ª–∏–∫","–ü–æ–¥–≤–∏–∂–Ω–æ—Å—Ç—å –ø–ª–µ—á","–•–≤–∞—Ç/–≤–∏—Å","–û—Å–∞–Ω–∫–∞/–º–æ–±–∏–ª–∏—Ç–∏"]; const picked=new Set(PLAN.cooldown);
    options.forEach(name=>{ const row=document.createElement("label"); row.className="item";
      const chk=document.createElement("input"); chk.type="checkbox"; chk.checked=picked.has(name); chk.addEventListener("change", updateDrSel);
      row.appendChild(document.createElement("div")).innerHTML=`<b>${name}</b>`; row.appendChild(chk); list.appendChild(row);
    });
  } else {
    const arr = DB.exercises.filter(e=> e.group===DR.group).slice().sort((a,b)=>{
      const ad=a.lastDate? new Date(a.lastDate):null, bd=b.lastDate? new Date(b.lastDate):null;
      if(!ad && bd) return -1; if(ad && !bd) return 1; if(!ad && !bd) return a.name.localeCompare(b.name); return ad-bd || a.name.localeCompare(b.name);
    });
    const picked = new Set((role==="main"?PLAN.main:PLAN.aux).map(x=> x.exId));
    arr.forEach(ex=>{ const row=document.createElement("label"); row.className="item";
      const last=ex.lastDate? fmt(ex.lastDate):"‚Äî"; const pr=(ex.pr==null?"‚Äî":ex.pr+" –∫–≥");
      const left=document.createElement("div"); left.innerHTML=`<div><b>${ex.name}</b></div><div class="muted">–ü–æ–¥—Ö–æ–¥—ã: 4 ¬∑ PR: ${pr} ¬∑ –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: ${last}</div>`;
      const chk=document.createElement("input"); chk.type="checkbox"; chk.checked=picked.has(ex.id); chk.addEventListener("change", updateDrSel);
      row.appendChild(left); row.appendChild(chk); list.appendChild(row); row.dataset.exid=ex.id; row.dataset.name=ex.name;
    });
  }
  updateDrSel(); $("drawer").classList.add("open");
}
function updateDrSel(){ const checks=[...$("drList").querySelectorAll('input[type="checkbox"]')]; $("drSel").textContent = checks.filter(c=> c.checked).length; }
function closeDrawer(){ $("drawer").classList.remove("open"); }
$("drClose").addEventListener("click", closeDrawer); $("drawer").addEventListener("click",(e)=>{ if(e.target===e.currentTarget) closeDrawer(); });
$("drApply").addEventListener("click", ()=>{
  const checks=[...$("drList").querySelectorAll('input[type="checkbox"]')]; const chosen=checks.map((c,i)=> c.checked? $("drList").children[i]:null).filter(Boolean);
  if(DR.role==="cool"){ if(chosen.length!==2){ toast("–ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ä–æ–≤–Ω–æ 2"); return; } PLAN.cooldown=chosen.map(r=> r.querySelector("b").textContent); closeDrawer(); renderPlanArea(); toast("–ó–∞–º–∏–Ω–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞"); return; }
  if(DR.role==="main" && chosen.length!==3){ toast("–û—Å–Ω–æ–≤–Ω–∞—è: –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–≤–Ω–æ 3"); return; }
  if(DR.role==="aux" && (chosen.length<2 || chosen.length>3)){ toast("–î–æ–ø.: –≤—ã–±–µ—Ä–∏—Ç–µ 2 –∏–ª–∏ 3"); return; }
  const mapped = chosen.map(row=>{ const exId=row.dataset.exid, name=row.dataset.name; const ex=DB.exercises.find(e=> e.id===exId); return {exId,name,sets:4,pr:(ex?.pr??0)}; });
  if(DR.role==="main") PLAN.main=mapped; else PLAN.aux=mapped; closeDrawer(); renderPlanArea(); toast("–û–±–Ω–æ–≤–ª–µ–Ω–æ");
});

/* Save workout */
async function saveWorkout(){
  if(!PLAN){ toast("–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –ø–ª–∞–Ω"); return; }
  const dateISO=PLAN.dateISO||todayISO();
  const applyInc=(arr)=> arr.map(it=>{
    const inc=PLAN.increments[it.exId]||0; const ex=DB.exercises.find(e=> e.id===it.exId);
    const old = (typeof ex?.pr==="number")? ex.pr : ((typeof it.pr==="number")? it.pr : 0);
    const newPR = inc? (old+inc) : (ex?.pr ?? null); // –µ—Å–ª–∏ 0 –¥–æ–±–∞–≤–∫–∏ –∏ –Ω–µ –±—ã–ª–æ PR ‚Äî –Ω–µ –ø–∏—à–µ–º 0
    if(newPR!=null && ex){ ex.pr=newPR; }
    if(ex){ ex.lastDate=dateISO; }
    return {name:it.name, sets:it.sets, weight:(newPR ?? null)};
  });
  const rec={ date:dateISO, day:PLAN.day, mainGroup:PLAN.mainGroup, auxGroup:PLAN.auxGroup, main:applyInc(PLAN.main), aux:applyInc(PLAN.aux), cooldown:PLAN.cooldown.slice(0,2) };
  DB.workouts.push(rec); await saveDB(); setPrevWorkoutLabel(); $("btnSave").disabled=true; toast("–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
}

/* Add Weight overlay */
let AW={group:"–ì—Ä—É–¥—å", exId:null, delta:0};
function openAddWeight(){ const def=(PLAN?.mainGroup)||"–ì—Ä—É–¥—å"; $("awGroup").value=def; AW.group=def; AW.delta=0; updateAWExercises(); updateAWInfo(); document.getElementById("ov-add").classList.add("open"); }
function updateAWExercises(){ const sel=$("awExercise"); sel.innerHTML=""; const list=DB.exercises.filter(e=> e.group===AW.group); list.forEach(e=>{ const o=document.createElement("option"); o.value=e.id; o.textContent=e.name; sel.appendChild(o); }); AW.exId=sel.value||null; }
function updateAWInfo(){ const ex=DB.exercises.find(e=> e.id===AW.exId); const pr=ex?.pr; const last=ex?.lastDate; $("awPrev").textContent=(pr==null?"‚Äî":pr+" –∫–≥"); $("awPrevDate").textContent=last?fmt(last):"‚Äî"; $("awDelta").textContent=AW.delta; }
$("awGroup").addEventListener("change",(e)=>{ AW.group=e.target.value; AW.delta=0; updateAWExercises(); updateAWInfo(); });
$("awExercise").addEventListener("change",()=>{ AW.delta=0; updateAWInfo(); });
$("awPlus").addEventListener("click",()=>{ AW.delta+=2.5; updateAWInfo(); });
$("awMinus").addEventListener("click",()=>{ AW.delta=Math.max(0,AW.delta-2.5); updateAWInfo(); });
$("awApply").addEventListener("click",()=>{ if(!AW.exId){toast("–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"); return;} const ex=DB.exercises.find(e=> e.id===AW.exId); const old=(typeof ex.pr==="number")?ex.pr:0; if(AW.delta===0){toast("–ù–µ—á–µ–≥–æ –¥–æ–±–∞–≤–ª—è—Ç—å"); return;} ex.pr=old+AW.delta; ex.lastDate=todayISO(); saveDB(); toast("PR –æ–±–Ω–æ–≤–ª—ë–Ω"); document.getElementById("ov-add").classList.remove("open"); });

/* Exercises */
function renderExercises(){ 
  const g=$("exGroup").value; 
  const q=$("exSearch").value.trim().toLowerCase(); 
  const list=$("exList"); 
  list.innerHTML=""; 
  DB.exercises.filter(e=> e.group===g).filter(e=> !q || e.name.toLowerCase().includes(q)).forEach(ex=>{ 
    const last=ex.lastDate?fmt(ex.lastDate):"‚Äî"; 
    const pr=ex.pr==null?"‚Äî":(ex.pr+" –∫–≥"); 
    const row=document.createElement("div"); 
    row.className="item"; 
    row.innerHTML=`<div><b>${ex.name}</b><div class="muted">PR: ${pr} ¬∑ –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: ${last} ¬∑ –ü–æ–¥—Ö–æ–¥—ã: 4</div></div><span class="tag">${ex.group}</span>`; 
    list.appendChild(row); 
  }); 
}
$("exGroup").addEventListener("change", renderExercises);
$("exSearch").addEventListener("input", renderExercises);

function renderHistory(){
  const area=$("measurementsArea"); area.innerHTML="";
  // –°–æ–∑–¥–∞–µ–º wrapper —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π
  const wrapper=document.createElement("div"); wrapper.className="history-table-wrapper";
  // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å 5 –∫–æ–ª–æ–Ω–∫–∞–º–∏
  const table=document.createElement("div"); table.className="history-table";
  const header=document.createElement("div"); header.className="history-header";
  header.innerHTML=`
    <div>–ó–∞–º–µ—Ä</div>
    <div id="col2Header"><input id="date2" type="date" value="${todayISO()}" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--fg);"></div>
    <div id="col3Header"><input id="date3" type="date" value="${todayISO()}" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--fg);"></div>
    <div id="col4Header"><input id="date4" type="date" value="${todayISO()}" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--fg);"></div>
    <div id="col5Header"><input id="date5" type="date" value="${todayISO()}" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--fg);"></div>
  `;
  table.appendChild(header);

  // –†—è–¥—ã —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –∑–∞–º–µ—Ä–æ–≤ –∏ input –ø–æ–ª—è–º–∏ –≤ –∫–æ–ª–æ–Ω–∫–∞—Ö
  measurementsList.forEach(measure=>{
    const row=document.createElement("div"); row.className="history-row";
    row.innerHTML=`
      <div>${measure.label}</div>
      <div><input id="input${measure.key}_2" type="number" step="0.1" placeholder="—Å–º" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--fg);"></div>
      <div><input id="input${measure.key}_3" type="number" step="0.1" placeholder="—Å–º" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--fg);"></div>
      <div><input id="input${measure.key}_4" type="number" step="0.1" placeholder="—Å–º" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--fg);"></div>
      <div><input id="input${measure.key}_5" type="number" step="0.1" placeholder="—Å–º" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--fg);"></div>
    `;
    table.appendChild(row);
  });
  wrapper.appendChild(table);
  area.appendChild(wrapper);

  // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ DB.measurements (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
  console.log(`üìä –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É ${DB.measurements.length} –∫–æ–ª–æ–Ω–∫–∞–º–∏ –∏–∑ Firebase`);
  DB.measurements.forEach((columnData, index) => {
    console.log(`üìÖ –ö–æ–ª–æ–Ω–∫–∞ ${index + 1}:`, columnData);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ (–∫–æ–ª–æ–Ω–∫–∞ 2 —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç col1 –≤ –¥–∞–Ω–Ω—ã—Ö)
    const colIndex = index + 2;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –≤ DOM
    const dateInput = $(`date${colIndex}`);
    if (dateInput && columnData.date) {
      dateInput.value = columnData.date;
      console.log(`   ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–∞—Ç–∞ –∫–æ–ª–æ–Ω–∫–∏ ${colIndex}: ${columnData.date}`);

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–º–µ—Ä–æ–≤
      measurementsList.forEach(measure => {
        const input = $(`input${measure.key}_${colIndex}`);
        if (input && columnData[measure.key] !== undefined) {
          input.value = columnData[measure.key];
          console.log(`   ‚úÖ ${measure.label} –∫–æ–ª–æ–Ω–∫–∏ ${colIndex}: ${columnData[measure.key]}`);
        }
      });
    } else {
      console.log(`   ‚ùå –ö–æ–ª–æ–Ω–∫–∞ ${colIndex} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ DOM –∏–ª–∏ –ø—É—Å—Ç–∞—è –¥–∞—Ç–∞`);
    }
  });

  // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
  const saveButton = document.createElement("button");
  saveButton.className = "btn btn-primary";
  saveButton.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
  saveButton.style.marginTop = "16px";
  saveButton.addEventListener("click", async ()=>{
    console.log("üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ Firebase (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)");
    console.log("üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö:");

    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫
    const columnsData = {};
    for (let col = 2; col <= 5; col++) {
      const dateInput = $(`date${col}`);
      console.log(`üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–æ–Ω–∫—É ${col}:`);
      console.log(`   - dateInput —ç–ª–µ–º–µ–Ω—Ç:`, dateInput);
      console.log(`   - dateInput.value:`, dateInput ? dateInput.value : '—ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');

      if (!dateInput || !dateInput.value) {
        columnsData[`col${col-1}`] = null;
        console.log(`‚è≠Ô∏è –ö–æ–ª–æ–Ω–∫–∞ ${col} –ø—Ä–æ–ø—É—â–µ–Ω–∞ - –Ω–µ—Ç –¥–∞—Ç—ã`);
        continue;
      }

      console.log(`üìÖ –ö–æ–ª–æ–Ω–∫–∞ ${col} –∏–º–µ–µ—Ç –¥–∞—Ç—É: ${dateInput.value}`);

      const columnData = {date: dateInput.value};
      let hasAtLeastOneValue = false;

      measurementsList.forEach(m => {
        const input = $(`input${m.key}_${col}`);
        const val = parseFloat(input.value);
        console.log(`   ${m.label} (${m.key}_${col}): —ç–ª–µ–º–µ–Ω—Ç=${input ? '–Ω–∞–π–¥–µ–Ω' : '–Ω–µ –Ω–∞–π–¥–µ–Ω'}, –∑–Ω–∞—á–µ–Ω–∏–µ="${input ? input.value : 'N/A'}", —á–∏—Å–ª–æ=${val}`);

        if (!isNaN(val) && val > 0) {
          columnData[m.key] = val;
          hasAtLeastOneValue = true;
          console.log(`   ‚úÖ ${m.label}: ${val}`);
        }
      });

      columnsData[`col${col-1}`] = hasAtLeastOneValue ? columnData : null;
    }

    console.log("üìã –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", columnsData);

    if (Object.values(columnsData).every(col => col === null)) {
      console.log("‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
      toast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ");
      return;
    }

    await saveAllMeasurementsToFirebase();
  });

  area.appendChild(saveButton);
  // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∫–æ–ª–æ–Ω–æ–∫ - —É–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
  // $("col2Header").addEventListener("click", ()=> saveColumn(2));
  // $("col3Header").addEventListener("click", ()=> saveColumn(3));
  // $("col4Header").addEventListener("click", ()=> saveColumn(4));
  // $("col5Header").addEventListener("click", ()=> saveColumn(5));
}

function renderNutrition(){
  const area=$("nutritionArea"); area.innerHTML="";
  // –°–æ–∑–¥–∞–µ–º wrapper —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π
  const wrapper=document.createElement("div"); wrapper.className="history-table-wrapper";
  // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å 5 –∫–æ–ª–æ–Ω–∫–∞–º–∏
  const table=document.createElement("div"); table.className="history-table";
  const header=document.createElement("div"); header.className="history-header";
  header.innerHTML=`
    <div>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</div>
    <div id="nutrition-col2Header"><input id="nutrition-date2" type="date" value="${todayISO()}" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--fg);"></div>
    <div id="nutrition-col3Header"><input id="nutrition-date3" type="date" value="${todayISO()}" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--fg);"></div>
    <div id="nutrition-col4Header"><input id="nutrition-date4" type="date" value="${todayISO()}" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--fg);"></div>
    <div id="nutrition-col5Header"><input id="nutrition-date5" type="date" value="${todayISO()}" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--fg);"></div>
  `;
  table.appendChild(header);

  // –†—è–¥—ã —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –ø–∏—Ç–∞–Ω–∏—è –∏ input –ø–æ–ª—è–º–∏ –≤ –∫–æ–ª–æ–Ω–∫–∞—Ö
  nutritionList.forEach(nutritionItem=>{
    const row=document.createElement("div"); row.className="history-row";
    row.innerHTML=`
      <div>${nutritionItem.label}</div>
      <div><input id="input${nutritionItem.key}_2" type="number" step="${nutritionItem.key==='weight'?'0.1':'1'}" placeholder="${nutritionItem.key==='calories'?'–∫–∫–∞–ª':nutritionItem.key==='steps'?'—à–∞–≥–æ–≤':'–∫–≥'}" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--fg);"></div>
      <div><input id="input${nutritionItem.key}_3" type="number" step="${nutritionItem.key==='weight'?'0.1':'1'}" placeholder="${nutritionItem.key==='calories'?'–∫–∫–∞–ª':nutritionItem.key==='steps'?'—à–∞–≥–æ–≤':'–∫–≥'}" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--fg);"></div>
      <div><input id="input${nutritionItem.key}_4" type="number" step="${nutritionItem.key==='weight'?'0.1':'1'}" placeholder="${nutritionItem.key==='calories'?'–∫–∫–∞–ª':nutritionItem.key==='steps'?'—à–∞–≥–æ–≤':'–∫–≥'}" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--fg);"></div>
      <div><input id="input${nutritionItem.key}_5" type="number" step="${nutritionItem.key==='weight'?'0.1':'1'}" placeholder="${nutritionItem.key==='calories'?'–∫–∫–∞–ª':nutritionItem.key==='steps'?'—à–∞–≥–æ–≤':'–∫–≥'}" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--fg);"></div>
    `;
    table.appendChild(row);
  });
  wrapper.appendChild(table);
  area.appendChild(wrapper);

  // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ DB.nutrition (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
  console.log(`üìä –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–∏—Ç–∞–Ω–∏—è ${DB.nutrition.length} –∫–æ–ª–æ–Ω–∫–∞–º–∏ –∏–∑ Firebase`);
  DB.nutrition.forEach((columnData, index) => {
    console.log(`üìÖ –ö–æ–ª–æ–Ω–∫–∞ –ø–∏—Ç–∞–Ω–∏—è ${index + 1}:`, columnData);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ (–∫–æ–ª–æ–Ω–∫–∞ 2 —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç nutrition_col1 –≤ –¥–∞–Ω–Ω—ã—Ö)
    const colIndex = index + 2;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –≤ DOM
    const dateInput = $(`nutrition-date${colIndex}`);
    if (dateInput && columnData.date) {
      dateInput.value = columnData.date;
      console.log(`   ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–∞—Ç–∞ –∫–æ–ª–æ–Ω–∫–∏ –ø–∏—Ç–∞–Ω–∏—è ${colIndex}: ${columnData.date}`);

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –ø–∏—Ç–∞–Ω–∏—è
      nutritionList.forEach(nutritionItem => {
        const input = $(`input${nutritionItem.key}_${colIndex}`);
        if (input && columnData[nutritionItem.key] !== undefined) {
          input.value = columnData[nutritionItem.key];
          console.log(`   ‚úÖ ${nutritionItem.label} –∫–æ–ª–æ–Ω–∫–∏ –ø–∏—Ç–∞–Ω–∏—è ${colIndex}: ${columnData[nutritionItem.key]}`);
        }
      });
    } else {
      console.log(`   ‚ùå –ö–æ–ª–æ–Ω–∫–∞ –ø–∏—Ç–∞–Ω–∏—è ${colIndex} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ DOM –∏–ª–∏ –ø—É—Å—Ç–∞—è –¥–∞—Ç–∞`);
    }
  });

  // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
  const saveButton = document.createElement("button");
  saveButton.className = "btn btn-primary";
  saveButton.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–∏—Ç–∞–Ω–∏—è";
  saveButton.style.marginTop = "16px";
  saveButton.addEventListener("click", async ()=>{
    console.log("üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–∏—Ç–∞–Ω–∏—è –≤ Firebase (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)");
    console.log("üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏ –ø–∏—Ç–∞–Ω–∏—è –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö:");

    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫ –ø–∏—Ç–∞–Ω–∏—è
    const nutritionColumnsData = {};
    for (let col = 2; col <= 5; col++) {
      const dateInput = $(`nutrition-date${col}`);
      console.log(`üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–æ–Ω–∫—É –ø–∏—Ç–∞–Ω–∏—è ${col}:`);
      console.log(`   - dateInput —ç–ª–µ–º–µ–Ω—Ç:`, dateInput);
      console.log(`   - dateInput.value:`, dateInput ? dateInput.value : '—ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');

      if (!dateInput || !dateInput.value) {
        nutritionColumnsData[`nutrition_col${col-1}`] = null;
        console.log(`‚è≠Ô∏è –ö–æ–ª–æ–Ω–∫–∞ –ø–∏—Ç–∞–Ω–∏—è ${col} –ø—Ä–æ–ø—É—â–µ–Ω–∞ - –Ω–µ—Ç –¥–∞—Ç—ã`);
        continue;
      }

      console.log(`üìÖ –ö–æ–ª–æ–Ω–∫–∞ –ø–∏—Ç–∞–Ω–∏—è ${col} –∏–º–µ–µ—Ç –¥–∞—Ç—É: ${dateInput.value}`);

      const columnData = {date: dateInput.value};
      let hasAtLeastOneValue = false;

      nutritionList.forEach(n => {
        const input = $(`input${n.key}_${col}`);
        const val = parseFloat(input.value);
        console.log(`   ${n.label} (${n.key}_${col}): —ç–ª–µ–º–µ–Ω—Ç=${input ? '–Ω–∞–π–¥–µ–Ω' : '–Ω–µ –Ω–∞–π–¥–µ–Ω'}, –∑–Ω–∞—á–µ–Ω–∏–µ="${input ? input.value : 'N/A'}", —á–∏—Å–ª–æ=${val}`);

        if (!isNaN(val) && val > 0) {
          columnData[n.key] = val;
          hasAtLeastOneValue = true;
          console.log(`   ‚úÖ ${n.label}: ${val}`);
        }
      });

      nutritionColumnsData[`nutrition_col${col-1}`] = hasAtLeastOneValue ? columnData : null;
    }

    console.log("üìã –î–∞–Ω–Ω—ã–µ –ø–∏—Ç–∞–Ω–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", nutritionColumnsData);

    if (Object.values(nutritionColumnsData).every(col => col === null)) {
      console.log("‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–∏—Ç–∞–Ω–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
      toast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ –ø–∏—Ç–∞–Ω–∏—è");
      return;
    }

    await saveNutritionToFirebase(nutritionColumnsData);
  });

  area.appendChild(saveButton);
}

async function saveNutritionToFirebase(nutritionColumnsData){
  console.log(`üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–∏—Ç–∞–Ω–∏—è –≤ Firebase (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)`);

  console.log("üìã –î–∞–Ω–Ω—ã–µ –ø–∏—Ç–∞–Ω–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", nutritionColumnsData);

  try {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π userId –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã (–∏–ª–∏ DB.user.name –µ—Å–ª–∏ –µ—Å—Ç—å)
    const userId = DB.user.name || "user123";
    const docRef = firebase.firestore().collection("measurements").doc(userId);

    await docRef.set({
      ...nutritionColumnsData,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    console.log(`‚úÖ –î–∞–Ω–Ω—ã–µ –ø–∏—Ç–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Firebase –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`);
    toast(`–î–∞–Ω–Ω—ã–µ –ø–∏—Ç–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Firebase`);

    // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    DB.nutrition = [];

  } catch(e) {
    console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–∏—Ç–∞–Ω–∏—è –≤ Firebase:", e);
    localStorage.setItem("ft_front_db_v2", JSON.stringify(DB));
    toast("–û—à–∏–±–∫–∞ Firebase ‚Äî –¥–∞–Ω–Ω—ã–µ –ø–∏—Ç–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ");
  }
}

async function saveAllMeasurementsToFirebase(){
  console.log(`üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Firebase (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)`);

  // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫
  const columnsData = {};
  for (let col = 2; col <= 5; col++) {
    const dateInput = $(`date${col}`);
    if (!dateInput || !dateInput.value) {
      columnsData[`col${col-1}`] = null;
      continue;
    }

    const columnData = {date: dateInput.value};
    let hasData = false;

    measurementsList.forEach(m => {
      const input = $(`input${m.key}_${col}`);
      const val = parseFloat(input.value);
      if (!isNaN(val) && val > 0) {
        columnData[m.key] = val;
        hasData = true;
      }
    });

    columnsData[`col${col-1}`] = hasData ? columnData : null;
  }

  console.log("üìã –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", columnsData);

  try {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π userId –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã (–∏–ª–∏ DB.user.name –µ—Å–ª–∏ –µ—Å—Ç—å)
    const userId = DB.user.name || "user123";
    const docRef = firebase.firestore().collection("measurements").doc(userId);

    await docRef.set({
      ...columnsData,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    console.log(`‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Firebase –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`);
    toast(`–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Firebase`);

    // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    DB.measurements = [];

  } catch(e) {
    console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firebase:", e);
    localStorage.setItem("ft_front_db_v2", JSON.stringify(DB));
    toast("–û—à–∏–±–∫–∞ Firebase ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ");
  }
}

function addNewColumn(){
  const newDate = todayISO();
  const newColIndex = document.querySelectorAll('.history-header > div').length; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫
  // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
  const addColumn = $("addNewColumn");
  addColumn.innerHTML = `<input id="date${newColIndex}" type="date" value="${newDate}" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--fg);">`;
  addColumn.id = `col${newColIndex}Header`;
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ä—è–¥—ã
  const rows = document.querySelectorAll(".history-row");
  rows.forEach((row, index)=>{
    const measure = measurementsList[index];
    const newCell = document.createElement("div");
    newCell.innerHTML = `<input id="input${measure.key}_${newColIndex}" type="number" step="0.1" placeholder="—Å–º" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--fg);"></div>`;
    row.appendChild(newCell);
  });
  // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –Ω–æ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏
  // $(`col${newColIndex}Header`).addEventListener("click", ()=> saveColumn(newColIndex));
  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å" –ø–æ—Å–ª–µ –Ω–æ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏
  const newAddColumn = document.createElement("div");
  newAddColumn.id = "addNewColumn";
  newAddColumn.textContent = "–î–æ–±–∞–≤–∏—Ç—å";
  newAddColumn.style.cursor = "pointer";
  newAddColumn.style.color = "var(--accent)";
  newAddColumn.addEventListener("click", ()=> addNewColumn());
  header.appendChild(newAddColumn);
  // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è grid
  renderHistory();
}

async function saveMeasurements(){
  const newDate=$("date5").value;
  const newMeasurement={date:newDate};
  let allFilled=true;
  measurementsList.forEach(m=>{
    const val=parseFloat($(`input${m.key}`).value);
    if(isNaN(val)){ allFilled=false; } else { newMeasurement[m.key]=val; }
  });
  if(!allFilled){ toast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è"); return; }

  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ DB
  DB.measurements.push(newMeasurement);

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –í–°–ï –¥–∞–Ω–Ω—ã–µ –≤ Firebase
  console.log(`üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–º–µ—Ä ${newDate} –≤ Firebase`);
  await saveAllMeasurementsToFirebase();

  // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  loadedMeasurements.push(newMeasurement);
  renderHistory();
  toast("–ó–∞–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω");
}

function saveMeasurementsToFile(){
  const data = {measurements: DB.measurements};
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "measurements.json";
  a.click();
  URL.revokeObjectURL(url);
  toast("–§–∞–π–ª measurements.json —Å–∫–∞—á–∞–Ω ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –≤ –ø—Ä–æ–µ–∫—Ç –≤—Ä—É—á–Ω—É—é");
}
/* Settings */
async function saveUserSettings(){
  await saveDB();
  toast("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
}

$("userName").addEventListener("blur",(e)=>{ DB.user.name=e.target.value.trim()||"–ê–Ω—Ç–æ–Ω"; saveUserSettings(); syncUserUI(); });
$("themeSel").addEventListener("change",(e)=>{ DB.user.theme=e.target.value; saveUserSettings(); syncUserUI(); });
$("btnExport").addEventListener("click", ()=>{ const blob=new Blob([JSON.stringify(DB,null,2)], {type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="fitness-data.json"; a.click(); URL.revokeObjectURL(url); });

/* Overlays */
document.querySelectorAll('[data-open]').forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    const id="ov-"+btn.getAttribute("data-open");
    document.getElementById(id).classList.add("open");
    if(id==="ov-exercises") renderExercises();
    if(id==="ov-plan"){ await setPrevWorkoutLabel(); await setInitPlanHeader(); }
    if(id==="ov-measurements") renderHistory();
    if(id==="ov-nutrition") renderNutrition();
    if(id==="ov-history") renderHistory();
    if(id==="ov-prev-workout") renderPrevWorkoutArea();
  });
});
document.querySelectorAll('[data-overlay]').forEach(ov=>{
  ov.addEventListener("click",(e)=>{ if(e.target===ov) ov.classList.remove("open"); });
  ov.querySelector('[data-close]').addEventListener("click",()=> ov.classList.remove("open"));
});
document.addEventListener("keydown",(e)=>{
  if(e.key==="Escape"){
    document.querySelectorAll(".overlay.open").forEach(ov=> ov.classList.remove("open"));
    if(document.getElementById("drawer").classList.contains("open")) document.getElementById("drawer").classList.remove("open");
  }
});

/* Plan buttons */
$("btnGen").addEventListener("click", ()=>{ PLAN=null; $("btnSave").disabled=true; planGenerate(); });
$("btnEditMain").addEventListener("click", ()=> openDrawer("main"));
$("btnEditAux").addEventListener("click", ()=> openDrawer("aux"));
$("btnEditCool").addEventListener("click", ()=> openDrawer("cool"));
$("btnAddWeight").addEventListener("click", openAddWeight);
$("btnSave").addEventListener("click", saveWorkout);

/* Previous Workout functionality */
let PREV_WORKOUT = null; // –î–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
let PREV_CHANGES = {}; // –ò–∑–º–µ–Ω–µ–Ω–∏—è PR –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
let prevWorkoutHandlersAttached = false; // –§–ª–∞–≥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

async function lastWorkout(){
  try {
    console.log('üîç –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –∏–∑ Firebase...');

    // –ó–∞–ø—Ä–æ—Å –∫ Firebase: workoutLog, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ message_id DESC, limit(1)
    const workoutLogRef = firebase.firestore().collection('workoutLog');
    const snapshot = await workoutLogRef
      .orderBy('message_id', 'desc')
      .limit(1)
      .get();

    if (!snapshot.empty) {
      const doc = snapshot.docs[0];
      const workoutData = doc.data();
      console.log('‚úÖ –ù–∞–π–¥–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞:', workoutData.date, workoutData.groups);
      return workoutData;
    } else {
      console.log('‚ö†Ô∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ Firebase');
      return null;
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏–∑ Firebase:', error);
    toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firebase - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ');
    return null;
  }
}

async function setPrevWorkoutLabel(){
  const lw = await lastWorkout();
  PREV_WORKOUT = lw;
  const groupsText = lw ? lw.groups : "‚Äî";
  const dayText = lw ? `–î–µ–Ω—å ${lw.day}` : "‚Äî";
  const dateText = lw ? fmt(lw.date) : "‚Äî";

  const prevWorkoutBtn = $("prevWorkout");
  if (prevWorkoutBtn) {
    if (lw) {
      prevWorkoutBtn.innerHTML = `–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: <b>${dateText} ¬∑ ${dayText} (${groupsText})</b><br><small style="color:var(--muted);">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å PR</small>`;
    } else {
      prevWorkoutBtn.innerHTML = `–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: <b>–Ω–µ –Ω–∞–π–¥–µ–Ω–∞</b><br><small style="color:var(--muted);">–í—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–µ–¥—ã–¥—É—â—É—é</small>`;
    }
  }

  const lastWorkoutInfo = $("lastWorkoutInfo");
  if (lastWorkoutInfo) {
    lastWorkoutInfo.style.display = "none";
  }
}

async function savePrevWorkoutChanges(){
  try {
    console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è PR –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏...');

    let hasChanges = false;
    for (const exerciseId in PREV_CHANGES) {
      if (PREV_CHANGES[exerciseId] !== 0) {
        hasChanges = true;
        break;
      }
    }

    if (!hasChanges) {
      toast('–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      return;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Firebase exercises
    console.log('üìã PREV_CHANGES:', PREV_CHANGES);
    console.log('üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ:', DB.exercises.map(ex => ({name: ex.name, id: ex.id})));

    for (const exerciseId in PREV_CHANGES) {
      const change = PREV_CHANGES[exerciseId];
      if (change !== 0) {
        console.log(`üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ${exerciseId} –Ω–∞ ${change}–∫–≥`);
        await updateExercisePR(exerciseId, change, true);
      }
    }

    console.log('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è PR —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
    toast('–ò–∑–º–µ–Ω–µ–Ω–∏—è PR —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');

    // –û–±–Ω–æ–≤–ª—è–µ–º PREV_WORKOUT —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ PR
    if (PREV_WORKOUT) {
      PREV_WORKOUT.main = PREV_WORKOUT.main.map(exercise => {
        const localExercise = DB.exercises.find(ex =>
          ex.name.toLowerCase().trim() === exercise.name.toLowerCase().trim()
        );
        if (localExercise) {
          exercise.weight = localExercise.pr;
        }
        return exercise;
      });

      PREV_WORKOUT.aux = PREV_WORKOUT.aux.map(exercise => {
        const localExercise = DB.exercises.find(ex =>
          ex.name.toLowerCase().trim() === exercise.name.toLowerCase().trim()
        );
        if (localExercise) {
          exercise.weight = localExercise.pr;
        }
        return exercise;
      });
    }

    // –û—á–∏—â–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    PREV_CHANGES = {};

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º popup
    document.getElementById('ov-prev-workout').classList.remove('open');

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π PR:', error);
    toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π');
  }
}

async function renderPrevWorkoutArea(){
  const box = $('prevWorkoutArea');
  if (!PREV_WORKOUT) {
    box.innerHTML = '<div class="empty">–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>';
    return;
  }

  box.innerHTML = ''; // –û—á–∏—â–∞–µ–º

  // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä—è–¥–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
  const makePrevRow = async (exercise, exerciseId) => {
    try {
      // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π PR –∏–∑ –∫—ç—à–∞
      let currentPR = exercise.weight || 0;

      // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
      const change = PREV_CHANGES[exerciseId] || 0;
      const displayedPR = currentPR + change;

      // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –∫–Ω–æ–ø–æ–∫
      let buttonsHtml = '';
      // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏, –¥–∞–∂–µ –µ—Å–ª–∏ exerciseId –Ω–µ –Ω–∞–π–¥–µ–Ω
      buttonsHtml = '<button class="btn" id="minus-' + exerciseId + '">‚àí2.5</button>' +
                   '<span class="pill">Œî: <b id="delta-' + exerciseId + '">' + (change > 0 ? '+' : '') + change + '</b> –∫–≥</span>' +
                   '<button class="btn" id="plus-' + exerciseId + '">+2.5</button>';

      const row = document.createElement("div");
      row.className = "item";

      row.innerHTML = `
        <div>
          <b>${exercise.name}</b>
          <div class="muted">${exercise.sets} –ø–æ–¥—Ö–æ–¥–∞ ¬∑ –¢–µ–∫—É—â–∏–π PR: <b>${currentPR} –∫–≥</b></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <span class="tag">–ò—Ç–æ–≥–æ–≤—ã–π: ${displayedPR} –∫–≥</span>
          ${buttonsHtml}
        </div>
      `;

      return row;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä—è–¥–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:', error);
      // Fallback: —Å–æ–∑–¥–∞–µ–º —Ä—è–¥ –±–µ–∑ Firebase –¥–∞–Ω–Ω—ã—Ö
      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div>
          <b>${exercise.name}</b>
          <div class="muted">${exercise.sets} –ø–æ–¥—Ö–æ–¥–∞ ¬∑ PR: ${exercise.weight || 0} –∫–≥</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <span class="tag">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</span>
        </div>
      `;
      return row;
    }
  };

  // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
  if (PREV_WORKOUT.main && PREV_WORKOUT.main.length > 0) {
    const h1 = document.createElement("div");
    h1.className = "muted";
    h1.textContent = "–û—Å–Ω–æ–≤–Ω—ã–µ";
    box.appendChild(h1);

    for (const exercise of PREV_WORKOUT.main) {
      // –ò—â–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ –ø–æ –∏–º–µ–Ω–∏
      const localExercise = DB.exercises.find(ex =>
        ex.name.toLowerCase().trim() === exercise.name.toLowerCase().trim()
      );
      const exerciseId = localExercise ? localExercise.id : `ex_${exercise.name.replace(/\s+/g, '_').toLowerCase()}`;
      const row = await makePrevRow(exercise, exerciseId);
      box.appendChild(row);
    }
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
  if (PREV_WORKOUT.main && PREV_WORKOUT.main.length > 0) {
    for (const exercise of PREV_WORKOUT.main) {
      // –ò—â–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ –ø–æ –∏–º–µ–Ω–∏
      const localExercise = DB.exercises.find(ex =>
        ex.name.toLowerCase().trim() === exercise.name.toLowerCase().trim()
      );
      const exerciseId = localExercise ? localExercise.id : `ex_${exercise.name.replace(/\s+/g, '_').toLowerCase()}`;
      const minusBtn = $(`minus-${exerciseId}`);
      const plusBtn = $(`plus-${exerciseId}`);

      if (minusBtn && plusBtn) {
        minusBtn.addEventListener("click", () => {
          PREV_CHANGES[exerciseId] = (PREV_CHANGES[exerciseId] || 0) - 2.5;
          renderPrevWorkoutArea(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        });

        plusBtn.addEventListener("click", () => {
          PREV_CHANGES[exerciseId] = (PREV_CHANGES[exerciseId] || 0) + 2.5;
          renderPrevWorkoutArea(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        });
      }
    }
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
  if (PREV_WORKOUT.aux && PREV_WORKOUT.aux.length > 0) {
    const h2 = document.createElement("div");
    h2.className = "muted";
    h2.style.marginTop = "12px";
    h2.textContent = "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ";
    box.appendChild(h2);

    for (const exercise of PREV_WORKOUT.aux) {
      // –ò—â–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ –ø–æ –∏–º–µ–Ω–∏
      const localExercise = DB.exercises.find(ex =>
        ex.name.toLowerCase().trim() === exercise.name.toLowerCase().trim()
      );
      const exerciseId = localExercise ? localExercise.id : `ex_${exercise.name.replace(/\s+/g, '_').toLowerCase()}`;
      const row = await makePrevRow(exercise, exerciseId);
      box.appendChild(row);
    }
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
  if (PREV_WORKOUT.aux && PREV_WORKOUT.aux.length > 0) {
    for (const exercise of PREV_WORKOUT.aux) {
      // –ò—â–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ –ø–æ –∏–º–µ–Ω–∏
      const localExercise = DB.exercises.find(ex =>
        ex.name.toLowerCase().trim() === exercise.name.toLowerCase().trim()
      );
      const exerciseId = localExercise ? localExercise.id : `ex_${exercise.name.replace(/\s+/g, '_').toLowerCase()}`;
      const minusBtn = $(`minus-${exerciseId}`);
      const plusBtn = $(`plus-${exerciseId}`);

      if (minusBtn && plusBtn) {
        minusBtn.addEventListener("click", () => {
          PREV_CHANGES[exerciseId] = (PREV_CHANGES[exerciseId] || 0) - 2.5;
          renderPrevWorkoutArea(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        });

        plusBtn.addEventListener("click", () => {
          PREV_CHANGES[exerciseId] = (PREV_CHANGES[exerciseId] || 0) + 2.5;
          renderPrevWorkoutArea(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        });
      }
    }
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
  if (!prevWorkoutHandlersAttached) {
    const saveBtn = $('btnSavePrevChanges');
    const cancelBtn = $('btnCancelPrevChanges');

    if (saveBtn) {
      saveBtn.addEventListener('click', savePrevWorkoutChanges);
    }

    if (cancelBtn) {
      cancelBtn.addEventListener('click', cancelPrevWorkoutChanges);
    }

    prevWorkoutHandlersAttached = true;
  }
}

async function cancelPrevWorkoutChanges(){
  console.log('‚ùå –û—Ç–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è PR –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏...');

  // –û—á–∏—â–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  PREV_CHANGES = {};

  // –ó–∞–∫—Ä—ã–≤–∞–µ–º popup
  document.getElementById('ov-prev-workout').classList.remove('open');

  toast('–ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω—ã');
}

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
document.addEventListener('DOMContentLoaded', () => {
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ renderPrevWorkoutArea
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è PR —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ Firebase
async function updateExercisePR(exerciseId, newPR, isDelta = false) {
  try {
    console.log(`üí™ –û–±–Ω–æ–≤–ª—è–µ–º PR –¥–ª—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è ${exerciseId}: ${isDelta ? `–¥–µ–ª—å—Ç–∞ ${newPR}` : `–Ω–æ–≤—ã–π PR ${newPR}–∫–≥`}`);

    // –ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ PR
    const exerciseDoc = await firebase.firestore().collection('exercises').doc(exerciseId).get();

    let currentPR = 0;
    if (exerciseDoc.exists) {
      const data = exerciseDoc.data();
      currentPR = data.pr_weight || 0;
    } else {
      console.log(`‚ö†Ô∏è –î–æ–∫—É–º–µ–Ω—Ç ${exerciseId} –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ`);
      return;
    }

    // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ PR
    const finalPR = isDelta ? (currentPR + newPR) : newPR;

    // –û–±–Ω–æ–≤–ª—è–µ–º PR –≤ Firebase
    await firebase.firestore().collection('exercises').doc(exerciseId).update({
      pr_weight: finalPR,
      pr_date: todayISO()
    });

    console.log(`‚úÖ PR –æ–±–Ω–æ–≤–ª–µ–Ω: ${currentPR}–∫–≥ ‚Üí ${finalPR}–∫–≥`);

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è PR:', error);
  }
}

/* Init */
(async function(){
  console.log("üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...");
  // –ù–ï –æ—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  await loadDB();
  await loadExercisesCache(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–∑ Firebase
  seedIfEmpty();
  await setPrevWorkoutLabel(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ
  console.log(`üìä –ü–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${DB.measurements.length} –∑–∞–º–µ—Ä–æ–≤ –∏ ${DB.exercises.length} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤ –ø–∞–º—è—Ç–∏`);
  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º UI —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤–∫–ª—é—á–∞—è —Ç–µ–º—É
  syncUserUI();
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∫–ª–∞–¥–∫–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
  if(document.querySelector('.tab')) initTabs();
  console.log("‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ");
})();
</script>
</body>
</html>
