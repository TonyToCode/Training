<!doctype html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–¢—Ä–µ–∫–µ—Ä —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ ‚Äî —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ v2</title>
  <!-- Firebase SDK v8 CDN (—Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBWCJ9LnW8etrHHutf0-VSzmqsdmrOiEt4",
      authDomain: "training-50f1c.firebaseapp.com",
      projectId: "training-50f1c",
      storageBucket: "training-50f1c.firebasestorage.app",
      messagingSenderId: "776443693745",
      appId: "1:776443693745:web:e3244e8d7ad0ef9ac97090",
      measurementId: "G-P40RSFC6PZ"
    };

    // Initialize Firebase
    try {
      firebase.initializeApp(firebaseConfig);
      firebase.analytics();
      console.log("‚úÖ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
    } catch (error) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", error);
    }

    // Make db available globally
    window.db = firebase.firestore();
    console.log("üîó Firestore –ø–æ–¥–∫–ª—é—á–µ–Ω:", !!window.db);
  </script>
<style>
  :root{
    --bg:#0f1115;--card:#171a21;--ink:#e7eefc;--muted:#9aa3b2;--line:#232836;
    --acc:#22c55e;--warn:#f59e0b;--danger:#ef4444;--chip:#0d1320;--chipline:#283149;
  }
  [data-theme="light"]{
    --bg:#f7f8fb;--card:#ffffff;--ink:#0f1115;--muted:#5f6b7a;--line:#e3e7ef;
    --acc:#16a34a;--warn:#d97706;--danger:#dc2626;--chip:#eef2ff;--chipline:#c7d2fe;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  body{background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--line);z-index:40}
  .wrap{max-width:1120px;margin:0 auto;padding:14px}
  h1{margin:0 0 6px;font-size:20px}
  .menu{display:flex;gap:8px;flex-wrap:wrap}
  .btn{background:transparent;border:1px solid var(--line);color:var(--ink);padding:9px 12px;border-radius:10px;cursor:pointer}
  .btn:hover{border-color:#94a3b8}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:var(--card);color:var(--ink);font-size:13px}
  .muted{color:var(--muted)}
  .tag{font-size:12px;color:var(--ink);background:var(--chip);border:1px solid var(--chipline);padding:2px 6px;border-radius:6px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:10px;border:1px solid var(--line);border-radius:10px;background:var(--card);background:color-mix(in srgb, var(--card) 90%, #000 10%)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .grow{flex:1}
  input{background:transparent;border:1px solid var(--line);border-radius:10px;padding:9px 10px;color:var(--ink)}
  input[type="date"]{padding:7px 10px}
  select{font-size:14px;border:1px solid var(--line);border-radius:8px;padding:8px 12px;background:var(--card);color:var(--ink);cursor:pointer;min-width:120px;transition:border-color 0.2s}
  select:hover{border-color:var(--acc);background:color-mix(in srgb, var(--card) 95%, var(--acc) 5%)}
  select:focus{outline:none;border-color:var(--acc);box-shadow:0 0 0 2px color-mix(in srgb, var(--acc) 20%, transparent)}
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:50}
  .overlay.open{display:flex}
  .popup{width:min(1020px,100% - 20px);max-height:86vh;overflow:auto}
  .popheader{position:sticky;top:0;background:var(--card);padding-bottom:8px;margin:-12px -12px 12px -12px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;border-radius:14px 14px 0 0}
  .x{border:1px solid var(--line);background:transparent;border-radius:10px;padding:6px 10px;cursor:pointer}
  .drawer{position:fixed;inset:0;display:none;justify-content:flex-end;align-items:stretch;background:rgba(0,0,0,.35);z-index:60}
  .drawer.open{display:flex}
  .panel{width:min(520px,100%);background:var(--card);border-left:1px solid var(--line);padding:12px;overflow:auto}
  .sticky{position:sticky;bottom:0;background:color-mix(in srgb, var(--card) 80%, transparent);backdrop-filter:blur(4px);margin:-12px;border-radius:0 0 14px 14px;padding:10px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}
  .empty{border:1px dashed var(--line);border-radius:12px;padding:16px;text-align:center;color:var(--muted)}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:var(--card);color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px 12px;opacity:0;transition:opacity .2s;z-index:80}
  .toast.show{opacity:1}
  .history-table{display:grid;grid-template-columns:200px repeat(4, 150px);gap:8px;margin-bottom:16px;align-items:center}
  .history-header{font-weight:600;padding:8px;border-bottom:1px solid var(--line);display:contents}
  .history-header > div{text-align:center}
  .history-row{display:contents}
  .history-row > div{padding:6px;text-align:center;border:1px solid var(--line);background:var(--card)}
  #addColumn{cursor:pointer;color:var(--accent)}
  .history-form{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:16px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>–¢—Ä–µ–∫–µ—Ä —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h1>
    <div class="menu">
      <button class="btn" data-open="plan">–ü–ª–∞–Ω</button>
      <button class="btn" data-open="exercises">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</button>
      <button class="btn" data-open="measurements">–ò—Å—Ç–æ—Ä–∏—è</button>
      <button class="btn" data-open="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <span class="pill">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <b id="userLabel">‚Äî</b></span>
      <span class="pill">–¢–µ–º–∞: <b id="themeLabel">–¢—ë–º–Ω–∞—è</b></span>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <h3 style="margin:0 0 8px">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h3>
    <p class="muted">–¢—Ä–µ–∫–µ—Ä —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ JSON.</p>
  </section>
</main>

<!-- PLAN -->
<div class="overlay" id="ov-plan" data-overlay>
  <div class="popup card">
    <div class="popheader">
      <h3 style="margin:0 8px">–ü–ª–∞–Ω</h3>
      <button class="x" data-close>‚úï</button>
    </div>
    <div class="row" style="margin-bottom:8px">
      <span class="pill">–ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–∞–Ω—è—Ç–∏–µ: <b id="prevWorkout">‚Äî</b></span>
    </div>
    <div class="card" style="margin-bottom:10px">
      <div class="row">
        <label class="pill">–î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–Ω—è—Ç–∏—è
          <input id="planDate" type="date">
        </label>
        <label class="pill">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –¥–µ–Ω—å —Ü–∏–∫–ª–∞
          <select id="daySel">
            <option value="1">1 ‚Äî –ù–æ–≥–∏/–ü–ª–µ—á–∏</option>
            <option value="2">2 ‚Äî –ì—Ä—É–¥—å/–ë–∏—Ü–µ–ø—Å</option>
            <option value="3">3 ‚Äî –°–ø–∏–Ω–∞/–¢—Ä–∏—Ü–µ–ø—Å</option>
          </select>
        </label>
        <button class="btn" id="btnGen">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>

    <div id="planArea" class="list">
      <div class="empty">–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –ø–ª–∞–Ω, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.</div>
    </div>

    <div class="row" style="margin:12px 0 0">
      <button class="btn" id="btnEditMain">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é</button>
      <button class="btn" id="btnEditAux">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é</button>
      <button class="btn" id="btnEditCool">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–∏–Ω–∫—É</button>
      <button class="btn" id="btnAddWeight">–î–æ–±–∞–≤–∏—Ç—å –≤–µ—Å</button>
      <div class="grow"></div>
      <button class="btn" id="btnSave" disabled>–û—Ç–º–µ—Ç–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
    </div>
  </div>
</div>

<!-- Drawer -->
<div class="drawer" id="drawer">
  <div class="panel card">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 id="drTitle" style="margin:0">–†–µ–¥–∞–∫—Ç–æ—Ä</h3>
      <button class="x" id="drClose">‚úï</button>
    </div>
    <div class="row" style="margin-bottom:8px">
      <span class="pill">–ì—Ä—É–ø–ø–∞: <b id="drGroup">‚Äî</b></span>
      <span class="pill">–í—ã–±—Ä–∞–Ω–æ: <b id="drSel">0</b></span>
      <span class="pill">–ù—É–∂–Ω–æ: <b id="drNeed">0</b></span>
    </div>
    <div id="drList" class="list" style="margin-bottom:10px"></div>
    <div class="sticky">
      <button class="btn" id="drApply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- ADD WEIGHT -->
<div class="overlay" id="ov-add" data-overlay>
  <div class="popup card">
    <div class="popheader">
      <h3 style="margin:0 8px">–î–æ–±–∞–≤–∏—Ç—å –≤–µ—Å (PR)</h3>
      <button class="x" data-close>‚úï</button>
    </div>
    <div class="list">
      <div class="item">
        <div>–ì—Ä—É–ø–ø–∞</div>
        <select id="awGroup">
          <option>–ù–æ–≥–∏</option><option>–ì—Ä—É–¥—å</option><option>–°–ø–∏–Ω–∞</option>
          <option>–ü–ª–µ—á–∏</option><option>–ë–∏—Ü–µ–ø—Å</option><option>–¢—Ä–∏—Ü–µ–ø—Å</option>
        </select>
      </div>
      <div class="item">
        <div>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</div>
        <select id="awExercise"></select>
      </div>
      <div class="item">
        <div class="grow">
          <div class="muted">–ü—Ä–µ–¥—ã–¥—É—â–∏–π PR: <b id="awPrev">‚Äî</b></div>
          <div class="muted">–î–∞—Ç–∞ PR: <b id="awPrevDate">‚Äî</b></div>
        </div>
        <div>
          <button class="btn" id="awMinus">‚àí2.5</button>
          <span class="pill">Œî: <b id="awDelta">0</b> –∫–≥</span>
          <button class="btn" id="awPlus">+2.5</button>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn" id="awApply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- EXERCISES -->
<div class="overlay" id="ov-exercises" data-overlay>
  <div class="popup card">
    <div class="popheader">
      <h3 style="margin:0 8px">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h3>
      <button class="x" data-close>‚úï</button>
    </div>
    <div class="row" style="margin-bottom:8px">
      <select id="exGroup">
        <option>–ù–æ–≥–∏</option><option>–ì—Ä—É–¥—å</option><option>–°–ø–∏–Ω–∞</option>
        <option>–ü–ª–µ—á–∏</option><option>–ë–∏—Ü–µ–ø—Å</option><option>–¢—Ä–∏—Ü–µ–ø—Å</option>
      </select>
      <input id="exSearch" placeholder="–ü–æ–∏—Å–∫‚Ä¶">
    </div>
    <div id="exList" class="list"></div>
  </div>
</div>

<!-- MEASUREMENTS -->
<div class="overlay" id="ov-measurements" data-overlay>
  <div class="popup card">
    <div class="popheader">
      <h3 style="margin:0 8px">–ò—Å—Ç–æ—Ä–∏—è</h3>
      <button class="x" data-close>‚úï</button>
    </div>
    <div id="measurementsArea"></div>
  </div>
</div>

<!-- SETTINGS -->
<div class="overlay" id="ov-settings" data-overlay>
  <div class="popup card">
    <div class="popheader">
      <h3 style="margin:0 8px">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      <button class="x" data-close>‚úï</button>
    </div>
    <div class="list">
      <div class="item">
        <div>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
        <input id="userName" class="grow" placeholder="–ê–Ω—Ç–æ–Ω">
      </div>
      <div class="item">
        <div>–¢–µ–º–∞</div>
        <select id="themeSel">
          <option value="dark">–¢—ë–º–Ω–∞—è</option>
          <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
        </select>
      </div>
      <div class="item">
        <div>–î–∞–Ω–Ω—ã–µ</div>
        <button class="btn" id="btnExport">–°–∫–∞—á–∞—Ç—å JSON</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
"use strict";
const $ = (id)=>document.getElementById(id);
const fmt = (d)=> new Date(d).toLocaleDateString('ru-RU');
function isoDateOnly(d){ const dt=new Date(d); const y=dt.getFullYear(); const m=("0"+(dt.getMonth()+1)).slice(-2); const da=("0"+dt.getDate()).slice(-2); return `${y}-${m}-${da}`; }
function todayISO(){ return isoDateOnly(new Date()); }
function toast(msg){ const t=$("toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1200); }

/* DB */
let DB = { user:{name:"–ê–Ω—Ç–æ–Ω", theme:"dark"}, exercises:[], workouts:[], measurements:[] };
let loadedMeasurements = []; // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
let measurementsList = []; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Å–ø–∏—Å–∫–∞ –∑–∞–º–µ—Ä–æ–≤

async function loadDB(){
  console.log("üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firebase...");
  // –û—á–∏—â–∞–µ–º DB –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
  DB.measurements = [];
  loadedMeasurements = [];

  try{
    const querySnapshot = await firebase.firestore().collection("measurements").get();
    querySnapshot.forEach((doc) => {
      const data = doc.data();
      DB.measurements.push(data);
      loadedMeasurements.push(data);
    });
    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${DB.measurements.length} –∑–∞–º–µ—Ä–æ–≤ –∏–∑ Firebase`);
    toast(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${DB.measurements.length} –∑–∞–º–µ—Ä–æ–≤`);
  }catch(e){
    console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:", e);
    toast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase");
    DB.measurements = [];
    loadedMeasurements = [];
  }
}

async function saveDB(){
  console.log("üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ Firebase...");
  const measurementsToSave = DB.measurements.filter(m => !loadedMeasurements.some(lm => lm.date === m.date && JSON.stringify(lm) === JSON.stringify(m)));
  
  if (measurementsToSave.length === 0) {
    console.log("‚ÑπÔ∏è –ù–µ—Ç –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
    toast("–ù–µ—Ç –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö");
    return;
  }

  console.log(`üì§ –°–æ—Ö—Ä–∞–Ω—è–µ–º ${measurementsToSave.length} –Ω–æ–≤—ã—Ö –∑–∞–º–µ—Ä–æ–≤`);
  
  try{
    for (const measurement of measurementsToSave) {
      const docRef = await firebase.firestore().collection("measurements").add(measurement);
      console.log(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω –∑–∞–º–µ—Ä ${measurement.date} —Å ID: ${docRef.id}`);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º loadedMeasurements
    loadedMeasurements.push(...measurementsToSave);
    console.log(`‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Firebase (${measurementsToSave.length} –∑–∞–º–µ—Ä–æ–≤)`);
    toast(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${measurementsToSave.length} –∑–∞–º–µ—Ä–æ–≤ –≤ Firebase`);
  }catch(e){
    console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firebase:", e);
    // Fallback: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
    localStorage.setItem("ft_front_db_v2", JSON.stringify(DB));
    toast("–û—à–∏–±–∫–∞ Firebase ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ");
  }
}

/* Seed demo exercises + measurements */
async function loadExercisesFromJSON(){
  try{
    const response = await fetch('./reference_normalized (1).json');
    const data = await response.json();
    const exercisesByGroup = {};
    data.records.forEach(record => {
      const { group, number, name, value, date } = record;
      if (!exercisesByGroup[group]) exercisesByGroup[group] = {};
      if (!exercisesByGroup[group][number]) exercisesByGroup[group][number] = { name, values: [], dates: [] };
      exercisesByGroup[group][number].values.push(value);
      exercisesByGroup[group][number].dates.push(date);
    });
    DB.exercises = []; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    for (const group of Object.keys(exercisesByGroup)){
      const nums = Object.keys(exercisesByGroup[group]).sort((a,b)=>a-b); // –ë–µ—Ä–µ–º –≤—Å–µ –Ω–æ–º–µ—Ä–∞
      for (const num of nums){
        if (group === "–ù–æ–≥–∏" && num === 10) continue; // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –Ω–æ–º–µ—Ä 10 –¥–ª—è –Ω–æ–≥
        const ex = exercisesByGroup[group][num];
        const maxValue = Math.max(...ex.values);
        const lastDate = ex.dates[ex.values.indexOf(maxValue)];
        if (maxValue > 0 && lastDate) { // –§–∏–ª—å—Ç—Ä—É–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –±–µ–∑ PR –∏–ª–∏ –¥–∞—Ç—ã
          DB.exercises.push({
            id: (ex.name.toLowerCase() + "__" + group + "__" + num), // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π id —Å –Ω–æ–º–µ—Ä–æ–º
            name: ex.name,
            group: group,
            pr: maxValue,
            lastDate: lastDate
          });
        }
      }
    }
  } catch(e){
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSON:", e);
    toast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON");
  }
}

function seedIfEmpty(){
  if(!DB.exercises.length){
    loadExercisesFromJSON(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ JSON –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
  }
  // –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—É—é —Ç–∞–±–ª–∏—Ü—É –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firebase
  console.log(`üìä –î–æ—Å—Ç—É–ø–Ω–æ –∑–∞–º–µ—Ä–æ–≤: ${DB.measurements.length}`);
}

/* Theme & User */
function applyTheme(){ document.documentElement.setAttribute("data-theme", DB.user.theme||"dark"); $("themeLabel").textContent = DB.user.theme==="light"?"–°–≤–µ—Ç–ª–∞—è":"–¢—ë–º–Ω–∞—è"; }
function syncUserUI(){ $("userLabel").textContent=DB.user.name||"‚Äî"; $("userName").value=DB.user.name||""; $("themeSel").value=DB.user.theme||"dark"; applyTheme(); }

/* Plan state */
const CYCLE={1:{main:"–ù–æ–≥–∏",aux:"–ü–ª–µ—á–∏"},2:{main:"–ì—Ä—É–¥—å",aux:"–ë–∏—Ü–µ–ø—Å"},3:{main:"–°–ø–∏–Ω–∞",aux:"–¢—Ä–∏—Ü–µ–ø—Å"}};
let PLAN=null;
function lastWorkout(){ if(!DB.workouts.length) return null; return DB.workouts.slice().sort((a,b)=> new Date(b.date)-new Date(a.date))[0]; }
function suggestedDay(){ const lw=lastWorkout(); if(!lw) return 1; return lw.day===3?1:lw.day+1; }
function setPrevWorkoutLabel(){ const lw=lastWorkout(); $("prevWorkout").textContent = lw? `${fmt(lw.date)} ¬∑ –î–µ–Ω—å ${lw.day} (${lw.mainGroup}/${lw.auxGroup})` : "‚Äî"; }
function setInitPlanHeader(){ $("planDate").value=todayISO(); $("daySel").value=String(suggestedDay()); }

function defaultCooldown(day){ return day===1?["–ü–ª–∞–Ω–∫–∞/–∫–æ—Ä","–ü—Ä–µ—Å—Å"]:(day===2?["–ú–§–†/—Ä–æ–ª–∏–∫","–ü–æ–¥–≤–∏–∂–Ω–æ—Å—Ç—å –ø–ª–µ—á"]:["–•–≤–∞—Ç/–≤–∏—Å","–û—Å–∞–Ω–∫–∞/–º–æ–±–∏–ª–∏—Ç–∏"]); }

function planGenerate(){
  const day=Number($("daySel").value); const dateISO=$("planDate").value||todayISO();
  const mainGroup=CYCLE[day].main, auxGroup=CYCLE[day].aux;
  const exMain = DB.exercises.filter(e=> e.group===mainGroup).slice(0,3);
  const exAux  = DB.exercises.filter(e=> e.group===auxGroup).slice(0,2);
  PLAN = {
    dateISO, day, mainGroup, auxGroup,
    main: exMain.map(e=> ({exId:e.id, name:e.name, sets:4, pr:(e.pr==null?0:e.pr)})),
    aux:  exAux.map(e=> ({exId:e.id, name:e.name, sets:4, pr:(e.pr==null?0:e.pr)})),
    cooldown: defaultCooldown(day),
    increments:{}
  };
  renderPlanArea(); $("btnSave").disabled=false; toast("–ü–ª–∞–Ω —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω");
}

function renderPlanArea(){
  const box=$("planArea");
  if(!PLAN){ box.innerHTML='<div class="empty">–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –ø–ª–∞–Ω, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.</div>'; return; }
  const makeRow=(it)=>{
    const ex=DB.exercises.find(x=> x.id===it.exId);
    const base = (typeof it.pr==="number")? it.pr : (typeof ex?.pr==="number"? ex.pr : 0);
    const inc = PLAN.increments[it.exId]||0;
    const shown = base + (inc? inc:0);
    const row=document.createElement("div"); row.className="item";
    row.innerHTML = `<div><b>${it.name}</b><div class="muted">${it.sets} –ø–æ–¥—Ö–æ–¥–∞ ¬∑ PR: <b>${(base||0)} –∫–≥</b></div></div>`;
    const right=document.createElement("div");
    right.innerHTML = `<span class="tag">–ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é: ${shown} –∫–≥</span> <button class="btn plus">+2.5</button>`;
    right.querySelector(".plus").addEventListener("click", ()=>{ PLAN.increments[it.exId]=(PLAN.increments[it.exId]||0)+2.5; renderPlanArea(); });
    row.appendChild(right); return row;
  };
  box.innerHTML="";
  const h1=document.createElement("div"); h1.className="muted"; h1.textContent="–û—Å–Ω–æ–≤–Ω—ã–µ (3)"; box.appendChild(h1);
  PLAN.main.forEach(it=> box.appendChild(makeRow(it)));
  const h2=document.createElement("div"); h2.className="muted"; h2.style.marginTop="6px"; h2.textContent="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ (2‚Ä¶3)"; box.appendChild(h2);
  PLAN.aux.forEach(it=> box.appendChild(makeRow(it)));
  const h3=document.createElement("div"); h3.className="muted"; h3.style.marginTop="6px"; h3.textContent="–ó–∞–º–∏–Ω–∫–∞ (2)"; box.appendChild(h3);
  PLAN.cooldown.forEach(n=>{ const row=document.createElement("div"); row.className="item"; row.innerHTML = `<div><b>${n}</b><div class="muted">–±–µ–∑ –≤–µ—Å–æ–≤</div></div>`; box.appendChild(row); });
}

/* Drawer editors */
let DR={role:null,need:0,group:null};
function openDrawer(role){
  if(!PLAN){ toast("–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –ø–ª–∞–Ω"); return; }
  DR.role=role; const isMain=role==="main"; DR.group=isMain?PLAN.mainGroup:(role==="aux"?PLAN.auxGroup:"–ó–∞–º–∏–Ω–∫–∞"); DR.need=role==="cool"?2:(isMain?3:2);
  $("drTitle").textContent = isMain? "–†–µ–¥–∞–∫—Ç–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–π" : (role==="aux"?"–†–µ–¥–∞–∫—Ç–æ—Ä –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π":"–†–µ–¥–∞–∫—Ç–æ—Ä –∑–∞–º–∏–Ω–∫–∏");
  $("drGroup").textContent=DR.group; $("drNeed").textContent=DR.need;
  const list=$("drList"); list.innerHTML="";
  if(role==="cool"){
    const options=["–ü–ª–∞–Ω–∫–∞/–∫–æ—Ä","–ü—Ä–µ—Å—Å","–ú–§–†/—Ä–æ–ª–∏–∫","–ü–æ–¥–≤–∏–∂–Ω–æ—Å—Ç—å –ø–ª–µ—á","–•–≤–∞—Ç/–≤–∏—Å","–û—Å–∞–Ω–∫–∞/–º–æ–±–∏–ª–∏—Ç–∏"]; const picked=new Set(PLAN.cooldown);
    options.forEach(name=>{ const row=document.createElement("label"); row.className="item";
      const chk=document.createElement("input"); chk.type="checkbox"; chk.checked=picked.has(name); chk.addEventListener("change", updateDrSel);
      row.appendChild(document.createElement("div")).innerHTML=`<b>${name}</b>`; row.appendChild(chk); list.appendChild(row);
    });
  } else {
    const arr = DB.exercises.filter(e=> e.group===DR.group).slice().sort((a,b)=>{
      const ad=a.lastDate? new Date(a.lastDate):null, bd=b.lastDate? new Date(b.lastDate):null;
      if(!ad && bd) return -1; if(ad && !bd) return 1; if(!ad && !bd) return a.name.localeCompare(b.name); return ad-bd || a.name.localeCompare(b.name);
    });
    const picked = new Set((role==="main"?PLAN.main:PLAN.aux).map(x=> x.exId));
    arr.forEach(ex=>{ const row=document.createElement("label"); row.className="item";
      const last=ex.lastDate? fmt(ex.lastDate):"‚Äî"; const pr=(ex.pr==null?"‚Äî":ex.pr+" –∫–≥");
      const left=document.createElement("div"); left.innerHTML=`<div><b>${ex.name}</b></div><div class="muted">–ü–æ–¥—Ö–æ–¥—ã: 4 ¬∑ PR: ${pr} ¬∑ –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: ${last}</div>`;
      const chk=document.createElement("input"); chk.type="checkbox"; chk.checked=picked.has(ex.id); chk.addEventListener("change", updateDrSel);
      row.appendChild(left); row.appendChild(chk); list.appendChild(row); row.dataset.exid=ex.id; row.dataset.name=ex.name;
    });
  }
  updateDrSel(); $("drawer").classList.add("open");
}
function updateDrSel(){ const checks=[...$("drList").querySelectorAll('input[type="checkbox"]')]; $("drSel").textContent = checks.filter(c=> c.checked).length; }
function closeDrawer(){ $("drawer").classList.remove("open"); }
$("drClose").addEventListener("click", closeDrawer); $("drawer").addEventListener("click",(e)=>{ if(e.target===e.currentTarget) closeDrawer(); });
$("drApply").addEventListener("click", ()=>{
  const checks=[...$("drList").querySelectorAll('input[type="checkbox"]')]; const chosen=checks.map((c,i)=> c.checked? $("drList").children[i]:null).filter(Boolean);
  if(DR.role==="cool"){ if(chosen.length!==2){ toast("–ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ä–æ–≤–Ω–æ 2"); return; } PLAN.cooldown=chosen.map(r=> r.querySelector("b").textContent); closeDrawer(); renderPlanArea(); toast("–ó–∞–º–∏–Ω–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞"); return; }
  if(DR.role==="main" && chosen.length!==3){ toast("–û—Å–Ω–æ–≤–Ω–∞—è: –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–≤–Ω–æ 3"); return; }
  if(DR.role==="aux" && (chosen.length<2 || chosen.length>3)){ toast("–î–æ–ø.: –≤—ã–±–µ—Ä–∏—Ç–µ 2 –∏–ª–∏ 3"); return; }
  const mapped = chosen.map(row=>{ const exId=row.dataset.exid, name=row.dataset.name; const ex=DB.exercises.find(e=> e.id===exId); return {exId,name,sets:4,pr:(ex?.pr??0)}; });
  if(DR.role==="main") PLAN.main=mapped; else PLAN.aux=mapped; closeDrawer(); renderPlanArea(); toast("–û–±–Ω–æ–≤–ª–µ–Ω–æ");
});

/* Save workout */
async function saveWorkout(){
  if(!PLAN){ toast("–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –ø–ª–∞–Ω"); return; }
  const dateISO=PLAN.dateISO||todayISO();
  const applyInc=(arr)=> arr.map(it=>{
    const inc=PLAN.increments[it.exId]||0; const ex=DB.exercises.find(e=> e.id===it.exId);
    const old = (typeof ex?.pr==="number")? ex.pr : ((typeof it.pr==="number")? it.pr : 0);
    const newPR = inc? (old+inc) : (ex?.pr ?? null); // –µ—Å–ª–∏ 0 –¥–æ–±–∞–≤–∫–∏ –∏ –Ω–µ –±—ã–ª–æ PR ‚Äî –Ω–µ –ø–∏—à–µ–º 0
    if(newPR!=null && ex){ ex.pr=newPR; }
    if(ex){ ex.lastDate=dateISO; }
    return {name:it.name, sets:it.sets, weight:(newPR ?? null)};
  });
  const rec={ date:dateISO, day:PLAN.day, mainGroup:PLAN.mainGroup, auxGroup:PLAN.auxGroup, main:applyInc(PLAN.main), aux:applyInc(PLAN.aux), cooldown:PLAN.cooldown.slice(0,2) };
  DB.workouts.push(rec); await saveDB(); setPrevWorkoutLabel(); $("btnSave").disabled=true; toast("–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
}

/* Add Weight overlay */
let AW={group:"–ì—Ä—É–¥—å", exId:null, delta:0};
function openAddWeight(){ const def=(PLAN?.mainGroup)||"–ì—Ä—É–¥—å"; $("awGroup").value=def; AW.group=def; AW.delta=0; updateAWExercises(); updateAWInfo(); document.getElementById("ov-add").classList.add("open"); }
function updateAWExercises(){ const sel=$("awExercise"); sel.innerHTML=""; const list=DB.exercises.filter(e=> e.group===AW.group); list.forEach(e=>{ const o=document.createElement("option"); o.value=e.id; o.textContent=e.name; sel.appendChild(o); }); AW.exId=sel.value||null; }
function updateAWInfo(){ const ex=DB.exercises.find(e=> e.id===AW.exId); const pr=ex?.pr; const last=ex?.lastDate; $("awPrev").textContent=(pr==null?"‚Äî":pr+" –∫–≥"); $("awPrevDate").textContent=last?fmt(last):"‚Äî"; $("awDelta").textContent=AW.delta; }
$("awGroup").addEventListener("change",(e)=>{ AW.group=e.target.value; AW.delta=0; updateAWExercises(); updateAWInfo(); });
$("awExercise").addEventListener("change",()=>{ AW.delta=0; updateAWInfo(); });
$("awPlus").addEventListener("click",()=>{ AW.delta+=2.5; updateAWInfo(); });
$("awMinus").addEventListener("click",()=>{ AW.delta=Math.max(0,AW.delta-2.5); updateAWInfo(); });
$("awApply").addEventListener("click",()=>{ if(!AW.exId){toast("–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"); return;} const ex=DB.exercises.find(e=> e.id===AW.exId); const old=(typeof ex.pr==="number")?ex.pr:0; if(AW.delta===0){toast("–ù–µ—á–µ–≥–æ –¥–æ–±–∞–≤–ª—è—Ç—å"); return;} ex.pr=old+AW.delta; ex.lastDate=todayISO(); saveDB(); toast("PR –æ–±–Ω–æ–≤–ª—ë–Ω"); document.getElementById("ov-add").classList.remove("open"); });

/* Exercises */
function renderExercises(){ const g=$("exGroup").value; const q=$("exSearch").value.trim().toLowerCase(); const list=$("exList"); list.innerHTML=""; DB.exercises.filter(e=> e.group===g).filter(e=> !q || e.name.toLowerCase().includes(q)).forEach(ex=>{ const last=ex.lastDate?fmt(ex.lastDate):"‚Äî"; const pr=ex.pr==null?"‚Äî":(ex.pr+" –∫–≥"); const row=document.createElement("div"); row.className="item"; row.innerHTML=`<div><b>${ex.name}</b><div class="muted">PR: ${pr} ¬∑ –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: ${last} ¬∑ –ü–æ–¥—Ö–æ–¥—ã: 4</div></div><span class="tag">${ex.group}</span>`; list.appendChild(row); }); }
$("exGroup").addEventListener("change", renderExercises);
$("exSearch").addEventListener("input", renderExercises);

function renderHistory(){
  const area=$("measurementsArea"); area.innerHTML="";
  // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å 5 –∫–æ–ª–æ–Ω–∫–∞–º–∏
  const table=document.createElement("div"); table.className="history-table";
  const header=document.createElement("div"); header.className="history-header";
  header.innerHTML=`
    <div>–ó–∞–º–µ—Ä</div>
    <div id="col2Header"><input id="date2" type="date" value="${todayISO()}" style="width:100%;padding:6px;border:1px solid var(--line);border-radius:4px;background:var(--card);color:var(--ink);"></div>
    <div id="col3Header"><input id="date3" type="date" value="${todayISO()}" style="width:100%;padding:6px;border:1px solid var(--line);border-radius:4px;background:var(--card);color:var(--ink);"></div>
    <div id="col4Header"><input id="date4" type="date" value="${todayISO()}" style="width:100%;padding:6px;border:1px solid var(--line);border-radius:4px;background:var(--card);color:var(--ink);"></div>
    <div id="col5Header"><input id="date5" type="date" value="${todayISO()}" style="width:100%;padding:6px;border:1px solid var(--line);border-radius:4px;background:var(--card);color:var(--ink);"></div>
  `;
  // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firebase, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—É—é —Ç–∞–±–ª–∏—Ü—É
  if (DB.measurements.length === 0) {
    const emptyMessage = document.createElement("div");
    emptyMessage.className = "empty";
    emptyMessage.textContent = "–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞–º–µ—Ä–æ–≤. –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞–∂–º–∏—Ç–µ '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'.";
    area.appendChild(emptyMessage);
    return;
  }

  // –†—è–¥—ã —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –∑–∞–º–µ—Ä–æ–≤ –∏ input –ø–æ–ª—è–º–∏ –≤ –∫–æ–ª–æ–Ω–∫–∞—Ö
  measurementsList.forEach(measure=>{
    const row=document.createElement("div"); row.className="history-row";
    row.innerHTML=`
      <div>${measure.label}</div>
      <div><input id="input${measure.key}_2" type="number" step="0.1" placeholder="—Å–º" style="width:100%;padding:6px;border:1px solid var(--line);border-radius:4px;background:var(--card);color:var(--ink);"></div>
      <div><input id="input${measure.key}_3" type="number" step="0.1" placeholder="—Å–º" style="width:100%;padding:6px;border:1px solid var(--line);border-radius:4px;background:var(--card);color:var(--ink);"></div>
      <div><input id="input${measure.key}_4" type="number" step="0.1" placeholder="—Å–º" style="width:100%;padding:6px;border:1px solid var(--line);border-radius:4px;background:var(--card);color:var(--ink);"></div>
      <div><input id="input${measure.key}_5" type="number" step="0.1" placeholder="—Å–º" style="width:100%;padding:6px;border:1px solid var(--line);border-radius:4px;background:var(--card);color:var(--ink);"></div>
    `;
    table.appendChild(row);
  });
  area.appendChild(table);
  // –ö–Ω–æ–ø–∫–∞ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
  const saveButton = document.createElement("button");
  saveButton.className = "btn";
  saveButton.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
  saveButton.style.marginTop = "16px";
  saveButton.addEventListener("click", async ()=>{
    console.log("üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ Firebase");
    await saveAllMeasurementsToFirebase();
  });

  area.appendChild(saveButton);
  // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∫–æ–ª–æ–Ω–æ–∫
  $("col2Header").addEventListener("click", ()=> saveColumn(2));
  $("col3Header").addEventListener("click", ()=> saveColumn(3));
  $("col4Header").addEventListener("click", ()=> saveColumn(4));
  $("col5Header").addEventListener("click", ()=> saveColumn(5));
}

async function saveColumn(col){
  const newDate=$(`date${col}`).value;
  const newMeasurement={date:newDate};
  let allFilled=true;
  measurementsList.forEach(m=>{
    const val=parseFloat($(`input${m.key}_${col}`).value);
    if(isNaN(val)){ allFilled=false; } else { newMeasurement[m.key]=val; }
  });
  if(!allFilled || !newDate){ toast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è"); return; }

  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ DB
  DB.measurements.push(newMeasurement);

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –í–°–ï –¥–∞–Ω–Ω—ã–µ –≤ Firebase (–Ω–µ —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ)
  console.log(`üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–º–µ—Ä ${newDate} –≤ Firebase`);
  await saveAllMeasurementsToFirebase();

  // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  loadedMeasurements.push(newMeasurement);
  renderHistory();
  toast("–ö–æ–ª–æ–Ω–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
}

async function saveAllMeasurementsToFirebase(){
  try{
    for (const measurement of DB.measurements) {
      const docRef = await firebase.firestore().collection("measurements").add(measurement);
      console.log(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω –∑–∞–º–µ—Ä ${measurement.date} —Å ID: ${docRef.id}`);
    }
    toast(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${DB.measurements.length} –∑–∞–º–µ—Ä–æ–≤ –≤ Firebase`);
  }catch(e){
    console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firebase:", e);
    localStorage.setItem("ft_front_db_v2", JSON.stringify(DB));
    toast("–û—à–∏–±–∫–∞ Firebase ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ");
  }
}

function addNewColumn(){
  const newDate = todayISO();
  const newColIndex = document.querySelectorAll('.history-header > div').length; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫
  // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
  const addColumn = $("addNewColumn");
  addColumn.innerHTML = `<input id="date${newColIndex}" type="date" value="${newDate}" style="width:100%;padding:6px;border:1px solid var(--line);border-radius:4px;background:var(--card);color:var(--ink);">`;
  addColumn.id = `col${newColIndex}Header`;
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ä—è–¥—ã
  const rows = document.querySelectorAll(".history-row");
  rows.forEach((row, index)=>{
    const measure = measurementsList[index];
    const newCell = document.createElement("div");
    newCell.innerHTML = `<input id="input${measure.key}_${newColIndex}" type="number" step="0.1" placeholder="—Å–º" style="width:100%;padding:6px;border:1px solid var(--line);border-radius:4px;background:var(--card);color:var(--ink);"></div>`;
    row.appendChild(newCell);
  });
  // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –Ω–æ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏
  $(`col${newColIndex}Header`).addEventListener("click", ()=> saveColumn(newColIndex));
  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å" –ø–æ—Å–ª–µ –Ω–æ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏
  const newAddColumn = document.createElement("div");
  newAddColumn.id = "addNewColumn";
  newAddColumn.textContent = "–î–æ–±–∞–≤–∏—Ç—å";
  newAddColumn.style.cursor = "pointer";
  newAddColumn.style.color = "var(--accent)";
  newAddColumn.addEventListener("click", ()=> addNewColumn());
  header.appendChild(newAddColumn);
  // –û–±–Ω–æ–≤–ª—è–µ–º CSS –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
  const table = document.querySelector(".history-table");
  table.style.gridTemplateColumns = `200px repeat(${newColIndex + 1}, 150px)`;
  // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è grid
  renderHistory();
}

async function saveColumn(col){
  const newDate=$(`date${col}`).value;
  const newMeasurement={date:newDate};
  let allFilled=true;
  measurementsList.forEach(m=>{
    const val=parseFloat($(`input${m.key}_${col}`).value);
    if(isNaN(val)){ allFilled=false; } else { newMeasurement[m.key]=val; }
  });
  if(!allFilled || !newDate){ toast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è"); return; }

  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ DB
  DB.measurements.push(newMeasurement);

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –í–°–ï –¥–∞–Ω–Ω—ã–µ –≤ Firebase (–Ω–µ —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ)
  console.log(`üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–º–µ—Ä ${newDate} –≤ Firebase`);
  await saveAllMeasurementsToFirebase();

  // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  loadedMeasurements.push(newMeasurement);
  renderHistory();
  toast("–ö–æ–ª–æ–Ω–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
}

async function saveMeasurements(){
  const newDate=$("date5").value;
  const newMeasurement={date:newDate};
  let allFilled=true;
  measurementsList.forEach(m=>{
    const val=parseFloat($(`input${m.key}`).value);
    if(isNaN(val)){ allFilled=false; } else { newMeasurement[m.key]=val; }
  });
  if(!allFilled){ toast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è"); return; }

  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ DB
  DB.measurements.push(newMeasurement);

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –í–°–ï –¥–∞–Ω–Ω—ã–µ –≤ Firebase
  console.log(`üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–º–µ—Ä ${newDate} –≤ Firebase`);
  await saveAllMeasurementsToFirebase();

  // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  loadedMeasurements.push(newMeasurement);
  renderHistory();
  toast("–ó–∞–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω");
}

function saveMeasurementsToFile(){
  const data = {measurements: DB.measurements};
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "measurements.json";
  a.click();
  URL.revokeObjectURL(url);
  toast("–§–∞–π–ª measurements.json —Å–∫–∞—á–∞–Ω ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –≤ –ø—Ä–æ–µ–∫—Ç –≤—Ä—É—á–Ω—É—é");
}
/* Settings */
async function saveUserSettings(){
  await saveDB();
  toast("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
}

$("userName").addEventListener("blur",(e)=>{ DB.user.name=e.target.value.trim()||"–ê–Ω—Ç–æ–Ω"; saveUserSettings(); syncUserUI(); });
$("themeSel").addEventListener("change",(e)=>{ DB.user.theme=e.target.value; saveUserSettings(); syncUserUI(); });
$("btnExport").addEventListener("click", ()=>{ const blob=new Blob([JSON.stringify(DB,null,2)], {type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="fitness-data.json"; a.click(); URL.revokeObjectURL(url); });

/* Overlays */
document.querySelectorAll('[data-open]').forEach(btn=>{
  btn.addEventListener("click",()=>{
    const id="ov-"+btn.getAttribute("data-open");
    document.getElementById(id).classList.add("open");
    if(id==="ov-exercises") renderExercises();
    if(id==="ov-plan"){ setPrevWorkoutLabel(); setInitPlanHeader(); }
    if(id==="ov-measurements") renderHistory();
    if(id==="ov-history") renderHistory();
  });
});
document.querySelectorAll('[data-overlay]').forEach(ov=>{
  ov.addEventListener("click",(e)=>{ if(e.target===ov) ov.classList.remove("open"); });
  ov.querySelector('[data-close]').addEventListener("click",()=> ov.classList.remove("open"));
});
document.addEventListener("keydown",(e)=>{
  if(e.key==="Escape"){
    document.querySelectorAll(".overlay.open").forEach(ov=> ov.classList.remove("open"));
    if(document.getElementById("drawer").classList.contains("open")) document.getElementById("drawer").classList.remove("open");
  }
});

/* Plan buttons */
$("btnGen").addEventListener("click", ()=>{ PLAN=null; $("btnSave").disabled=true; planGenerate(); });
$("btnEditMain").addEventListener("click", ()=> openDrawer("main"));
$("btnEditAux").addEventListener("click", ()=> openDrawer("aux"));
$("btnEditCool").addEventListener("click", ()=> openDrawer("cool"));
$("btnAddWeight").addEventListener("click", openAddWeight);
$("btnSave").addEventListener("click", saveWorkout);

/* Init */
(async function(){ 
  console.log("üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...");
  // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
  localStorage.removeItem("ft_front_db_v2");
  await loadDB(); 
  await loadExercisesFromJSON(); // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
  seedIfEmpty(); 
  console.log(`üìä –ü–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${DB.measurements.length} –∑–∞–º–µ—Ä–æ–≤ –≤ –ø–∞–º—è—Ç–∏`);
  // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –≤–≤–æ–¥–µ
  syncUserUI(); 
  console.log("‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ");
})();
</script>
</body>
</html>
